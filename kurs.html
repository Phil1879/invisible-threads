<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Курс "Батьківські директиви"</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Батьківські директиви">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Батьківські директиви">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogItCR0LDRgtGM0LrRltCy0YHRjNC60ZYg0LTQuNGA0LXQutGC0LjQstC4IiwKICAic2hvcnRfbmFtZSI6ICLQlNC40YDQtdC60YLQuNCy0LgiLAogICJkZXNjcmlwdGlvbiI6ICLQn9GB0LjRhdC+0LvQvtCz0ZbRh9C90LjQuSDQutGD0YDRgSDQt9CyINCy0LjQstGH0LXQvdC90Y8g0YIg0L/RgNC+0YDQvtCx0LrQuCDQsdCw0YLRjNC60ZbQstGB0YzQutC40YUg0LTQuNGA0LXQutGC0LjQsiIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiM2NjdlZWEiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImh0dHBzOi8vcmVzMi53ZWJsaXVtLnNpdGUvcmVzLzY1NmUxNWQyOWEyZWIzMDAwZjlhMTYyZC82NTZmMDIzZmYwMjc5YjAwMGY3Yjk0MWJfb3B0aW1pemVkXzI2Mi53ZWJwIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS93ZWJwIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL3JlczIud2VibGl1bS5zaXRlL3Jlcy82NTZlMTVkMjlhMmViMzAwMGY5YTE2MmQvNjU2ZjAyM2ZmMDI3OWIwMDBmN2I5NDFiX29wdGltaXplZF8yNjIud2VicCIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvd2VicCIKICAgIH0KICBdCn0=">
    <link rel="apple-touch-icon" href="https://res2.weblium.site/res/656e15d29a2eb3000f9a162d/656f023ff0279b000f7b941b_optimized_262.webp">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; background: #000; border-radius: 12px; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .ai-chat { max-height: 400px; overflow-y: auto; }
        .message { margin-bottom: 12px; padding: 12px; border-radius: 8px; animation: slideIn 0.3s ease-out; }
        .message.user { background: #e0f2fe; text-align: right; margin-left: 20%; }
        .message.assistant { background: #f3f4f6; margin-right: 20%; }
        .message.system { background: #fef3c7; text-align: center; font-size: 0.875rem; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @media print {
            body * { visibility: hidden; }
            #certificate, #certificate * { visibility: visible; }
            #certificate { position: absolute; left: 0; top: 0; }
        }
        .certificate-frame {
            border: 20px solid;
            border-image: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%) 1;
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.3), inset 0 0 0 10px white;
        }
        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 6rem;
            font-weight: 900;
            color: rgba(255, 255, 255, 0.05);
            pointer-events: none;
            white-space: nowrap;
            z-index: 1;
        }
    </style>
</head>
<body class="bg-gray-50">

<div id="screen-register" class="min-h-screen flex items-center justify-center p-6 bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
    <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-10 fade-in">
        <img src="https://res2.weblium.site/res/656e15d29a2eb3000f9a162d/656f023ff0279b000f7b941b_optimized_262.webp" alt="Логотип" class="w-32 h-32 mx-auto mb-6 object-contain">
        <h1 class="text-2xl font-black text-center mb-1 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Батьківські директиви:<br>невидимі нитки</h1>
        <h2 class="text-2xl font-bold text-center mb-2 mt-4">Реєстрація</h2>
        <p class="text-gray-600 text-center mb-6">Створіть обліковий запис для старту</p>
        <div class="space-y-4">
            <input type="text" id="register-name" placeholder="Ваше ім'я" class="w-full px-4 py-3 border-2 rounded-xl focus:border-blue-500 outline-none">
            <input type="email" id="register-email" placeholder="Email" class="w-full px-4 py-3 border-2 rounded-xl focus:border-blue-500 outline-none">
            <input type="password" id="register-password" placeholder="Пароль (мінімум 6 символів)" class="w-full px-4 py-3 border-2 rounded-xl focus:border-blue-500 outline-none">
            <input type="password" id="register-password-confirm" placeholder="Підтвердіть пароль" class="w-full px-4 py-3 border-2 rounded-xl focus:border-blue-500 outline-none">
            <button onclick="register()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-4 rounded-xl hover:shadow-xl transition">
                Зареєструватись
            </button>
        </div>
        <p class="text-center text-sm text-gray-500 mt-4">Вже є код? <span class="text-blue-600 cursor-pointer hover:underline" onclick="showScreen('login')">Увійти</span></p>
        
        <div class="mt-8 pt-6 border-t border-gray-200">
            <p class="text-xs text-gray-400 text-center mb-3">Реєструючись, ви погоджуєтеся з:</p>
            <div class="flex flex-col gap-2">
                <button onclick="showLegalDoc('privacy')" class="text-xs text-blue-600 hover:underline">Політика конфіденційності</button>
                <button onclick="showLegalDoc('disclaimer')" class="text-xs text-blue-600 hover:underline">Відмова від відповідальності</button>
                <button onclick="showLegalDoc('terms')" class="text-xs text-blue-600 hover:underline">Договір публічної оферти</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-legal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-6 z-50" onclick="if(event.target === this) closeLegalDoc()">
    <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-8 fade-in">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-black text-gray-800" id="legal-title">Документ</h2>
            <button onclick="closeLegalDoc()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        <div id="legal-content" class="prose max-w-none text-gray-700"></div>
        <button onclick="closeLegalDoc()" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700">Закрити</button>
    </div>
</div>

<div id="screen-login" class="hidden min-h-screen flex items-center justify-center p-6 bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
    <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-10 fade-in">
        <img src="https://res2.weblium.site/res/656e15d29a2eb3000f9a162d/656f023ff0279b000f7b941b_optimized_262.webp" alt="Логотип" class="w-32 h-32 mx-auto mb-6 object-contain">
        <h1 class="text-2xl font-black text-center mb-1 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Батьківські директиви:<br>невидимі нитки</h1>
        <h2 class="text-2xl font-bold text-center mb-2 mt-4">Вхід</h2>
        <p class="text-gray-600 text-center mb-6">Введіть email та пароль</p>
        <div class="space-y-4">
            <input type="email" id="login-email" placeholder="Email" class="w-full px-4 py-3 border-2 rounded-xl focus:border-blue-500 outline-none">
            <input type="password" id="login-password" placeholder="Пароль" class="w-full px-4 py-3 border-2 rounded-xl focus:border-blue-500 outline-none">
            <button onclick="login()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-4 rounded-xl hover:shadow-xl transition">
                Увійти
            </button>
        </div>
        <p class="text-center text-sm text-gray-500 mt-4">Немає акаунту? <span class="text-blue-600 cursor-pointer hover:underline" onclick="showScreen('register')">Зареєструватись</span></p>
        <p class="text-center text-xs text-gray-400 mt-2">Адмін? <span class="text-purple-600 cursor-pointer hover:underline" onclick="showScreen('admin-login')">Адмін-панель</span></p>
        
        <div class="mt-8 pt-6 border-t border-gray-200">
            <div class="flex flex-col gap-2">
                <button onclick="showLegalDoc('privacy')" class="text-xs text-blue-600 hover:underline">Політика конфіденційності</button>
                <button onclick="showLegalDoc('disclaimer')" class="text-xs text-blue-600 hover:underline">Відмова від відповідальності</button>
                <button onclick="showLegalDoc('terms')" class="text-xs text-blue-600 hover:underline">Договір публічної оферти</button>
            </div>
        </div>
    </div>
</div>

<div id="screen-admin-login" class="hidden min-h-screen flex items-center justify-center p-6 bg-gradient-to-br from-purple-50 via-pink-50 to-red-50">
    <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-10 fade-in">
        <img src="https://res2.weblium.site/res/656e15d29a2eb3000f9a162d/656f023ff0279b000f7b941b_optimized_262.webp" alt="Логотип" class="w-32 h-32 mx-auto mb-6 object-contain">
        <h2 class="text-3xl font-black text-center mb-2 text-purple-600">🔐 Адмін-панель</h2>
        <p class="text-gray-600 text-center mb-6">Введіть адмін-код для доступу</p>
        <div class="space-y-4">
            <input type="password" id="admin-code-input" placeholder="Адмін-код" class="w-full px-4 py-3 border-2 rounded-xl focus:border-purple-500 outline-none">
            <button onclick="adminLogin()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-4 rounded-xl hover:shadow-xl transition">
                Увійти
            </button>
        </div>
        <p class="text-center text-sm text-gray-500 mt-4"><span class="text-blue-600 cursor-pointer hover:underline" onclick="showScreen('login')">← Назад до входу</span></p>
    </div>
</div>

<div id="screen-admin" class="hidden min-h-screen bg-gray-50">
    <nav class="bg-gradient-to-r from-purple-600 to-pink-600 shadow-lg">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <img src="https://res2.weblium.site/res/656e15d29a2eb3000f9a162d/656f023ff0279b000f7b941b_optimized_262.webp" alt="Логотип" class="w-12 h-12 object-contain bg-white rounded-full p-2">
                <h2 class="text-2xl font-black text-white">🔐 Адмін-панель</h2>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleAdminAI()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-semibold px-4 py-2 rounded-lg transition">🤖 ШІ Аналітик</button>
                <button onclick="adminLogout()" class="text-white hover:text-gray-200 font-semibold">Вийти</button>
            </div>
        </div>
    </nav>
    
    <div class="max-w-7xl mx-auto p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Всього користувачів</h3>
                    <span class="text-3xl">👥</span>
                </div>
                <div class="text-4xl font-black text-blue-600" id="admin-total-users">0</div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Завершили курс</h3>
                    <span class="text-3xl">🎓</span>
                </div>
                <div class="text-4xl font-black text-green-600" id="admin-completed">0</div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Активні студенти</h3>
                    <span class="text-3xl">🔥</span>
                </div>
                <div class="text-4xl font-black text-orange-600" id="admin-active">0</div>
            </div>
        </div>
        
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-black text-gray-800">⚠️ Логи помилок відео</h3>
                <div class="flex gap-2">
                    <button onclick="refreshVideoErrorLogs()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700">
                        🔄 Оновити
                    </button>
                    <button onclick="clearVideoErrorLogs()" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700">
                        🗑️ Очистити
                    </button>
                    <button onclick="exportVideoErrors()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700">
                        💾 Експорт
                    </button>
                </div>
            </div>
            <div id="video-error-stats" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>
            <div class="overflow-x-auto max-h-96 overflow-y-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="text-left py-2 px-3 font-bold text-gray-700">Час</th>
                            <th class="text-left py-2 px-3 font-bold text-gray-700">Урок</th>
                            <th class="text-left py-2 px-3 font-bold text-gray-700">Video ID</th>
                            <th class="text-left py-2 px-3 font-bold text-gray-700">Тип помилки</th>
                            <th class="text-left py-2 px-3 font-bold text-gray-700">Користувач</th>
                            <th class="text-left py-2 px-3 font-bold text-gray-700">Опис</th>
                        </tr>
                    </thead>
                    <tbody id="video-error-logs-table"></tbody>
                </table>
            </div>
        </div>
        
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-black text-gray-800">📋 Список користувачів</h3>
                <button onclick="exportUsers()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-700">
                    💾 Експорт CSV
                </button>
            </div>
            
            <div class="mb-4">
                <input type="text" id="admin-search" placeholder="🔍 Пошук за ім'ям, позивним або кодом..." class="w-full px-4 py-3 border-2 rounded-xl focus:border-purple-500 outline-none" onkeyup="filterUsers()">
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-200">
                            <th class="text-left py-3 px-4 font-bold text-gray-700">Ім'я</th>
                            <th class="text-left py-3 px-4 font-bold text-gray-700">Email</th>
                            <th class="text-center py-3 px-4 font-bold text-gray-700">Прогрес</th>
                            <th class="text-center py-3 px-4 font-bold text-gray-700">Бали</th>
                            <th class="text-center py-3 px-4 font-bold text-gray-700">Дата реєстрації</th>
                            <th class="text-center py-3 px-4 font-bold text-gray-700">Дії</th>
                        </tr>
                    </thead>
                    <tbody id="admin-users-table">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="admin-ai-assistant" class="hidden fixed bottom-6 right-6 w-[500px] bg-white rounded-2xl shadow-2xl border-2 border-purple-300 overflow-hidden z-50">
        <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-4 flex items-center justify-between">
            <h3 class="text-white font-bold">🤖 ШІ Аналітик Адміна</h3>
            <button onclick="toggleAdminAI()" class="text-white hover:text-gray-200">✕</button>
        </div>
        <div id="admin-ai-chat" class="ai-chat p-4 bg-gray-50" style="min-height: 400px; max-height: 500px;"></div>
        <div class="p-4 border-t bg-white">
            <div class="mb-3 flex gap-2">
                <button onclick="analyzeAllUsers()" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700">📊 Аналіз усіх</button>
                <button onclick="analyzeLowPerformers()" class="flex-1 bg-orange-600 text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-orange-700">⚠️ Слабкі</button>
                <button onclick="analyzeTopPerformers()" class="flex-1 bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-green-700">🏆 Кращі</button>
            </div>
            <div class="flex gap-2">
                <input type="text" id="admin-ai-input" placeholder="Запитайте про користувачів..." class="flex-1 px-4 py-2 border-2 rounded-lg focus:border-purple-500 outline-none" onkeypress="if(event.key==='Enter') sendAdminAIMessage()">
                <button onclick="sendAdminAIMessage()" class="bg-purple-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-purple-700">→</button>
            </div>
        </div>
    </div>
    
    <div id="admin-chat-modal" class="hidden fixed bottom-6 right-6 w-[500px] bg-white rounded-2xl shadow-2xl border-2 border-purple-300 overflow-hidden z-50">
        <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-4 flex items-center justify-between">
            <div>
                <h3 class="text-white font-bold">💬 Чат з користувачем</h3>
                <p class="text-white text-xs" id="admin-chat-user-name"></p>
            </div>
            <button onclick="closeAdminChat()" class="text-white hover:text-gray-200">✕</button>
        </div>
        <div id="admin-chat-messages" class="ai-chat p-4 bg-gray-50" style="min-height: 400px; max-height: 500px;"></div>
        <div class="p-4 border-t bg-white">
            <div class="flex gap-2">
                <input type="text" id="admin-chat-input" placeholder="Напишіть повідомлення..." class="flex-1 px-4 py-2 border-2 rounded-lg focus:border-purple-500 outline-none" onkeypress="if(event.key==='Enter') sendAdminMessage()">
                <button onclick="sendAdminMessage()" class="bg-purple-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-purple-700">→</button>
            </div>
        </div>
    </div>
</div>

<div id="screen-welcome" class="hidden min-h-screen flex items-center justify-center p-6 bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
    <div class="bg-white rounded-3xl shadow-2xl max-w-4xl w-full p-12 fade-in text-center">
        <img src="https://res2.weblium.site/res/656e15d29a2eb3000f9a162d/656f023ff0279b000f7b941b_optimized_262.webp" alt="Логотип" class="w-40 h-40 mx-auto mb-6 object-contain">
        <h1 class="text-5xl font-black bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-4">
            Вітаємо, <span id="welcome-name"></span>!
        </h1>
        <p class="text-xl text-gray-600 mb-2">Відео-курс для трансформації несвідомих програм</p>
        <p class="text-sm text-gray-500 mb-8">Ваш email: <strong id="welcome-email"></strong></p>
        <div class="grid grid-cols-4 gap-4 py-6 border-y border-gray-200 mb-8">
            <div><div class="text-3xl font-bold text-blue-600">16</div><div class="text-sm text-gray-500">Уроків</div></div>
            <div><div class="text-3xl font-bold text-purple-600">80</div><div class="text-sm text-gray-500">Питань</div></div>
            <div><div class="text-3xl font-bold text-indigo-600">~3</div><div class="text-sm text-gray-500">Години</div></div>
            <div><div class="text-3xl font-bold text-pink-600">400</div><div class="text-sm text-gray-500">Балів</div></div>
        </div>
        <button onclick="showScreen('dashboard')" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white text-xl font-bold py-5 px-12 rounded-2xl hover:shadow-xl transition">
            Розпочати навчання →
        </button>
    </div>
</div>

<div id="screen-dashboard" class="hidden min-h-screen bg-gray-50">
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <img src="https://res2.weblium.site/res/656e15d29a2eb3000f9a162d/656f023ff0279b000f7b941b_optimized_262.webp" alt="Логотип" class="w-12 h-12 object-contain">
                <h2 class="text-2xl font-black text-gray-800">Батьківські директиви</h2>
            </div>
            <div class="flex items-center gap-6">
                <button onclick="showScreen('workbook')" class="text-gray-600 hover:text-blue-600 font-semibold">📓 Робочий зошит</button>
                <button onclick="toggleAI()" class="text-gray-600 hover:text-blue-600 font-semibold">🤖 КураШІ</button>
                <button onclick="toggleUserMessages()" class="relative text-gray-600 hover:text-blue-600 font-semibold">
                    💬 Зв'язок з ТРЕНЕРОМ
                    <span id="unread-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                </button>
                <button onclick="toggleEmailSettings()" class="text-gray-600 hover:text-blue-600 font-semibold" title="Налаштування email">🔔</button>
                <div class="text-right">
                    <div class="text-xs text-gray-500">Прогрес</div>
                    <div class="text-lg font-bold text-blue-600"><span id="progress">0</span>/17</div>
                </div>
                <button onclick="showProfile()" class="flex items-center gap-2 text-gray-600 hover:text-blue-600">
                    <img id="nav-avatar" src="" alt="Avatar" class="w-8 h-8 rounded-full object-cover border-2 border-blue-500" onerror="this.src='https://ui-avatars.com/api/?name=User&background=3B82F6&color=fff'">
                </button>
                <button onclick="logout()" class="text-red-600 hover:text-red-800 text-sm">Вийти</button>
            </div>
        </div>
    </nav>
    <div class="max-w-7xl mx-auto p-6">
        <div id="lessons-container" class="space-y-4"></div>
    </div>
    
    <div id="ai-assistant" class="hidden fixed bottom-6 right-6 w-96 bg-white rounded-2xl shadow-2xl border-2 border-blue-200 overflow-hidden z-50">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4 flex items-center justify-between">
            <h3 class="text-white font-bold">🤖 КураШІ - помічник онлайн</h3>
            <button onclick="toggleAI()" class="text-white hover:text-gray-200">✕</button>
        </div>
        <div id="ai-chat" class="ai-chat p-4 bg-gray-50" style="min-height: 300px; max-height: 400px;"></div>
        <div class="p-4 border-t bg-white">
            <div class="flex gap-2">
                <input type="text" id="ai-input" placeholder="Задайте питання..." class="flex-1 px-4 py-2 border-2 rounded-lg focus:border-blue-500 outline-none" onkeypress="if(event.key==='Enter') sendAIMessage()">
                <button onclick="sendAIMessage()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700">→</button>
            </div>
        </div>
    </div>
    
    <div id="user-messages" class="hidden fixed bottom-6 right-6 w-[450px] bg-white rounded-2xl shadow-2xl border-2 border-blue-300 overflow-hidden z-50">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4 flex items-center justify-between">
            <h3 class="text-white font-bold">💬 Зв'язок з ТРЕНЕРОМ</h3>
            <button onclick="toggleUserMessages()" class="text-white hover:text-gray-200">✕</button>
        </div>
        <div id="user-messages-chat" class="ai-chat p-4 bg-gray-50" style="min-height: 350px; max-height: 450px;"></div>
        <div class="p-4 border-t bg-white">
            <div class="flex gap-2">
                <input type="text" id="user-message-input" placeholder="Напишіть повідомлення..." class="flex-1 px-4 py-2 border-2 rounded-lg focus:border-blue-500 outline-none" onkeypress="if(event.key==='Enter') sendUserMessage()">
                <button onclick="sendUserMessage()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700">→</button>
            </div>
        </div>
    </div>
    
    <div id="email-settings-modal" class="hidden fixed bottom-6 right-6 w-[450px] bg-white rounded-2xl shadow-2xl border-2 border-blue-300 overflow-hidden z-50">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4 flex items-center justify-between">
            <h3 class="text-white font-bold">🔔 Email сповіщення</h3>
            <button onclick="toggleEmailSettings()" class="text-white hover:text-gray-200">✕</button>
        </div>
        <div class="p-6">
            <div class="mb-6">
                <div class="flex items-center justify-between mb-4 pb-4 border-b">
                    <div>
                        <div class="font-bold text-gray-800">Нові уроки</div>
                        <div class="text-sm text-gray-500">Отримувати повідомлення про нові уроки</div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="email-new-lessons" class="sr-only peer" onchange="saveEmailPreferences()">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between mb-4 pb-4 border-b">
                    <div>
                        <div class="font-bold text-gray-800">Оновлення курсу</div>
                        <div class="text-sm text-gray-500">Важливі оновлення та зміни</div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="email-updates" class="sr-only peer" onchange="saveEmailPreferences()">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between mb-4 pb-4 border-b">
                    <div>
                        <div class="font-bold text-gray-800">Нагадування</div>
                        <div class="text-sm text-gray-500">Про незавершені уроки</div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="email-reminders" class="sr-only peer" onchange="saveEmailPreferences()">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-bold text-gray-800">Щотижневий звіт</div>
                        <div class="text-sm text-gray-500">Статистика вашого прогресу</div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="email-weekly" class="sr-only peer" onchange="saveEmailPreferences()">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>
            
            <div id="email-status" class="hidden mb-4 p-3 rounded-lg text-sm"></div>
            
            <button onclick="testEmailNotification()" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition">
                📧 Надіслати тестовий email
            </button>
        </div>
    </div>
</div>

<div id="screen-lesson" class="hidden min-h-screen bg-gray-50 p-6">
    <div class="max-w-4xl mx-auto">
        <button onclick="showScreen('dashboard')" class="mb-6 text-blue-600 hover:text-blue-800 font-semibold">← Назад до уроків</button>
        <div id="lesson-content"></div>
    </div>
</div>

<div id="screen-workbook" class="hidden min-h-screen bg-gray-50 p-6">
    <div class="max-w-4xl mx-auto">
        <button onclick="showScreen('dashboard')" class="mb-6 text-blue-600 hover:text-blue-800 font-semibold">← Назад</button>
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <h2 class="text-3xl font-black mb-6">📓 Мій Робочий Зошит</h2>
            <p class="text-gray-600 mb-4">Записуйте ваші думки, інсайти та спостереження під час проходження курсу</p>
            
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-xl mb-6 border-2 border-blue-200">
                <h3 class="text-xl font-bold mb-4 text-gray-800">📚 Матеріали для завантаження</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <a href="https://drive.google.com/file/d/1Op0LRh8kPd6jTdXlGBC4GrcgQmNtPja-/view?usp=sharing" target="_blank" class="flex items-center gap-3 bg-white p-4 rounded-lg hover:shadow-lg transition border-2 border-transparent hover:border-blue-400">
                        <span class="text-3xl">🇺🇦</span>
                        <div>
                            <div class="font-bold text-gray-800">Методичка (українською)</div>
                            <div class="text-xs text-gray-500">Робоча тетрадь PDF</div>
                        </div>
                    </a>
                    <a href="https://drive.google.com/file/d/1_I7ZTkRIdg2fvbfBP5n5Khb5A8esoJyZ/view?usp=sharing" target="_blank" class="flex items-center gap-3 bg-white p-4 rounded-lg hover:shadow-lg transition border-2 border-transparent hover:border-blue-400">
                        <span class="text-3xl">🇷🇺</span>
                        <div>
                            <div class="font-bold text-gray-800">Методичка (російською)</div>
                            <div class="text-xs text-gray-500">Робочая тетрадь PDF</div>
                        </div>
                    </a>
                    <a href="#" style="display:none;" target="_blank" class="flex items-center gap-3 bg-white p-4 rounded-lg hover:shadow-lg transition border-2 border-transparent hover:border-blue-400">
                        <span class="text-3xl">✅</span>
                        <div>
                            <div class="font-bold text-gray-800">Тести (українською)</div>
                            <div class="text-xs text-gray-500">Ітогові тести PDF</div>
                        </div>
                    </a>
                    <a href="#" style="display:none;" target="_blank" class="flex items-center gap-3 bg-white p-4 rounded-lg hover:shadow-lg transition border-2 border-transparent hover:border-blue-400">
                        <span class="text-3xl">✅</span>
                        <div>
                            <div class="font-bold text-gray-800">Тесты (русский)</div>
                            <div class="text-xs text-gray-500">Итоговые тесты PDF</div>
                        </div>
                    </a>
                </div>
            </div>
            
            <div class="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-xl mb-6 border-2 border-green-200">
                <h3 class="text-xl font-bold mb-4 text-gray-800">📱 Офлайн режим</h3>
                <p class="text-gray-600 mb-4">Збережіть курс на пристрій для перегляду без інтернету</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-white p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-bold text-gray-800">Сторінки курсу</span>
                            <span id="cache-pages-status" class="text-sm text-green-600">✅ Збережено</span>
                        </div>
                        <div class="text-sm text-gray-500">Доступні офлайн</div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-bold text-gray-800">Розмір кешу</span>
                            <span id="cache-size" class="text-sm text-blue-600">~ 2 MB</span>
                        </div>
                        <div class="text-sm text-gray-500">Зайнято на пристрої</div>
                    </div>
                </div>
                
                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-4">
                    <div class="flex items-start gap-2">
                        <span class="text-xl">⚠️</span>
                        <div class="text-sm text-yellow-800">
                            <strong>Важливо:</strong> Відео YouTube не можна зберегти офлайн через обмеження YouTube. В офлайн режимі доступні текстові матеріали, тести та інтерфейс.
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="clearOfflineCache()" class="flex-1 bg-red-600 text-white font-semibold py-3 rounded-lg hover:bg-red-700 transition">
                        🗑️ Очистити кеш
                    </button>
                    <button onclick="checkCacheStatus()" class="flex-1 bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition">
                        🔄 Перевірити статус
                    </button>
                </div>
            </div>
            
            <textarea id="workbook-text" class="w-full h-96 p-4 border-2 rounded-xl focus:border-blue-500 outline-none font-mono" placeholder="Почніть писати...\n\nНаприклад:\n- Які директиви я помітив(ла) у своєму житті?\n- Які ситуації викликають відгук?\n- Що хочу змінити?\n- Мої цілі після курсу..."></textarea>
            <button onclick="saveWorkbook()" class="mt-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-3 px-8 rounded-xl hover:shadow-xl transition">
                💾 Зберегти нотатки
            </button>
        </div>
    </div>
</div>

<div id="modal-certificate-name" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-6 z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 fade-in">
        <h2 class="text-2xl font-black text-center mb-2 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">🎉 Вітаємо!</h2>
        <p class="text-gray-600 text-center mb-6">Ви завершили курс! Введіть ваше повне ім'я для сертифікату:</p>
        <div class="space-y-4">
            <input type="text" id="cert-full-name" placeholder="Прізвище Ім'я" class="w-full px-4 py-3 border-2 rounded-xl focus:border-blue-500 outline-none">
            <button onclick="generateCertificate()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-4 rounded-xl hover:shadow-xl transition">
                Отримати сертифікат
            </button>
        </div>
    </div>
</div>

<div id="screen-certificate" class="hidden min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 p-6">
    <div class="max-w-5xl mx-auto">
        <div id="certificate" class="certificate-frame bg-white rounded-2xl shadow-2xl p-16 text-center relative" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);">
            <div class="watermark">VERIFIED</div>
            <img src="https://res2.weblium.site/res/656e15d29a2eb3000f9a162d/656f023ff0279b000f7b941b_optimized_262.webp" alt="Логотип" class="w-40 h-40 mx-auto mb-8 object-contain bg-white rounded-full p-4 shadow-xl relative z-10">
            <h1 class="text-6xl font-black text-white mb-4 tracking-wide relative z-10">СЕРТИФІКАТ</h1>
            <p class="text-2xl text-white mb-10 font-light relative z-10">про успішне завершення курсу</p>
            <div class="bg-white rounded-2xl p-10 mb-10 shadow-2xl relative z-10">
                <h2 class="text-5xl font-black bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-6" id="cert-name"></h2>
                <div class="grid grid-cols-4 gap-6 py-8 border-y-2 border-gray-200 my-6">
                    <div>
                        <div class="text-4xl font-black text-blue-600" id="cert-lessons">17</div>
                        <div class="text-sm text-gray-500 font-semibold mt-2">Уроків пройдено</div>
                    </div>
                    <div>
                        <div class="text-4xl font-black text-purple-600" id="cert-score">0</div>
                        <div class="text-sm text-gray-500 font-semibold mt-2">Балів набрано</div>
                    </div>
                    <div>
                        <div class="text-4xl font-black text-indigo-600" id="cert-hours">0</div>
                        <div class="text-sm text-gray-500 font-semibold mt-2">Годин навчання</div>
                    </div>
                    <div>
                        <div class="text-4xl font-black text-green-600">100%</div>
                        <div class="text-sm text-gray-500 font-semibold mt-2">Завершення</div>
                    </div>
                </div>
                <p class="text-gray-600 mt-6 text-base font-semibold">Дата завершення: <span class="text-gray-800" id="cert-date"></span></p>
            </div>
            <div class="grid grid-cols-2 gap-4 relative z-10">
                <div class="bg-white bg-opacity-20 rounded-xl p-6 backdrop-blur-sm">
                    <p class="text-white text-xl font-semibold">🎉 Вітаємо з трансформацією!</p>
                    <p class="text-white text-sm mt-2 font-light">Курс "Батьківські директиви: невидимі нитки"</p>
                </div>
                <div class="bg-white rounded-xl p-4 flex flex-col items-center justify-center">
                    <canvas id="cert-qrcode" class="w-24 h-24 mb-2"></canvas>
                    <p class="text-xs text-gray-600 font-semibold">Верифікація</p>
                    <p class="text-xs text-gray-500 mt-1">ID: <span id="cert-id"></span></p>
                </div>
            </div>
        </div>
        <div class="flex gap-4 mt-8 justify-center flex-wrap">
            <button onclick="downloadCertificatePNG()" class="bg-white text-blue-600 font-bold py-3 px-8 rounded-xl hover:shadow-xl transition">
                📥 Завантажити PNG
            </button>
            <button onclick="downloadCertificatePDF()" class="bg-white text-red-600 font-bold py-3 px-8 rounded-xl hover:shadow-xl transition">
                📄 Завантажити PDF
            </button>
            <button onclick="window.print()" class="bg-white text-purple-600 font-bold py-3 px-8 rounded-xl hover:shadow-xl transition">
                🖨️ Роздрукувати
            </button>
            <button onclick="showScreen('dashboard')" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-3 px-8 rounded-xl hover:shadow-xl transition">
                Повернутись до уроків
            </button>
        </div>
    </div>
</div>

<script>
const lessons = [
    { id: 0, title: 'Ввідний урок: Знайомство з курсом', description: 'Вітання та огляд курсу Батьківські Директиви', videoUrl: 'https://www.youtube.com/embed/wmaRjk2aK3E', duration: '05:00', points: 5, quiz: [
        { q: 'Що таке батьківська директива?', opts: ['Несвідоме послання', 'Пряма вказівка', 'Правило'], c: 0 },
        { q: 'Скільки уроків у курсі?', opts: ['10', '16', '12'], c: 1 },
        { q: 'Яка мета курсу?', opts: ['Розвага', 'Усвідомлення та трансформація', 'Знання'], c: 1 },
        { q: 'Чи потрібна робоча тетрадь?', opts: ['Ні', 'Не обов’язково', 'Так'], c: 2 },
        { q: 'Що важливо в курсі?', opts: ['Чесність з собою', 'Швидкість', 'Перфекціонізм'], c: 0 }
    ]},
    { id: 1, title: 'Урок 0: Що таке Батьківська Директива?', description: 'Ознайомлення з концепцією, історією та впливом несвідомих програм на життя', videoUrl: 'https://www.youtube.com/embed/z-ivL3YtFoo', duration: '08:15', points: 10, quiz: [
        { q: 'Хто вперше описав концепцію батьківських директив?', opts: ['Ерік Берн', 'Зиґмунд Фройд', 'Карл Юнг'], c: 0 },
        { q: 'На якому віці дитина зазвичай формує більшість директив?', opts: ['4-7 років', '0-3 роки', '8-12 років'], c: 1 },
        { q: 'Що таке батьківська директива?', opts: ['Несвідоме послання від батьків', 'Пряма вказівка батьків', 'Правило поведінки'], c: 0 },
        { q: 'Скільки основних директив виділяють?', opts: ['5', '20', '12'], c: 2 },
        { q: 'Як директиви впливають на доросле життя?', opts: ['Формують сценарій життя', 'Не впливають', 'Тільки в дитинстві'], c: 0 }
    ]},
    { id: 2, title: 'Урок 1: Не живи + Опрацювання', description: 'Найпотужніша директива. Теорія та практика опрацювання', videoUrl: 'https://www.youtube.com/embed/c9Fjiv4JfAY', videoUrl2: 'https://www.youtube.com/embed/D9lZVUElleY', duration: '25:00', points: 25, quiz: [
        { q: 'Який поведінковий прояв найбільш пов\'язаний з директивою «Не живи»?', opts: ['Прокрастинація', 'Хронічні хвороби', 'Надмірний перфекціонізм'], c: 1 },
        { q: 'Яка фраза може формувати директиву «Не живи»?', opts: ['Я тебе люблю', 'Краще б ти не народився', 'Ти моя радість'], c: 1 },
        { q: 'Як проявляється директива на рівні здоров\'я?', opts: ['Спортивність', 'Саморуйнівна поведінка', 'Міцне здоров\'я'], c: 1 },
        { q: 'Що відчуває людина з цією директивою?', opts: ['Впевненість', 'Відсутність права жити', 'Повноту життя'], c: 1 },
        { q: 'Як працювати з директивою «Не живи»?', opts: ['Боротися з нею', 'Дозволити собі жити', 'Ігнорувати'], c: 1 }
    ]},
    { id: 3, title: 'Урок 2: Не будь собою', description: 'Заборона на індивідуальність та прояв справжніх емоцій. Сценарій Хамелеон', videoUrl: 'https://www.youtube.com/embed/CYchGoaws5s', duration: '11:00', points: 25, quiz: [
        { q: 'Що таке сценарій Хамелеон?', opts: ['Постійна зміна масок для відповідності оточенню', 'Схильність до ризику', 'Нездатність приймати рішення'], c: 0 },
        { q: 'Яка фраза формує «Не будь собою»?', opts: ['Ти унікальний', 'Будь як всі', 'Будь самим собою'], c: 1 },
        { q: 'Головна проблема цієї директиви?', opts: ['Багато друзів', 'Самотність', 'Втрата себе справжнього'], c: 2 },
        { q: 'Як людина обирає професію з цією директивою?', opts: ['За бажанням батьків', 'За покликанням', 'Легко'], c: 0 },
        { q: 'Шлях до звільнення?', opts: ['Слухати інших', 'Пізнати себе справжнього', 'Змінюватися постійно'], c: 1 }
    ]},
    { id: 4, title: 'Урок 3: Не роби', description: 'Блокування дій, схильність до прокрастинації, саботаж своїх починань', videoUrl: 'https://www.youtube.com/embed/OsIf05UYbGE', duration: '12:15', points: 25, quiz: [
        { q: 'Яка установка батьків найчастіше призводить до директиви Не роби?', opts: ['Залиш, я сам(а) зроблю', 'Роби все ідеально', 'Ти маєш бути лідером'], c: 0 },
        { q: 'Головний симптом директиви «Не роби»?', opts: ['Імпульсивність', 'Гіперактивність', 'Прокрастинація'], c: 2 },
        { q: 'Що відчуває людина перед дією?', opts: ['Паралізуючий страх', 'Ентузіазм', 'Радість'], c: 0 },
        { q: 'Чому батьки блокували дії дитини?', opts: ['Зі злості', 'Із любові', 'З турботи, щоб не помилилась'], c: 2 },
        { q: 'Як подолати директиву?', opts: ['Діяти маленькими кроками', 'Нічого не робити', 'Чекати натхнення'], c: 0 }
    ]},
    { id: 5, title: 'Урок 4: Не досягай успіху', description: 'Самосаботаж, страх успіху, комплекс Йони', videoUrl: 'https://www.youtube.com/embed/PF6W1UBKNGU', duration: '15:00', points: 25, quiz: [
        { q: 'Який термін описує стан людини з директивою Не дорослішай?', opts: ['Синдром відмінника', 'Синдром Пітера Пена', 'Синдром самозванця'], c: 1 },
        { q: 'Типова фраза батьків?', opts: ['Ти ще маленький', 'Дорослішай швидше', 'Будь самостійним'], c: 0 },
        { q: 'Головний страх?', opts: ['Самотності', 'Успіху', 'Відповідальності'], c: 1 },
        { q: 'Як проявляється у стосунках?', opts: ['Рівноправність', 'Лідерство', 'Пошук батьківської фігури'], c: 2 },
        { q: 'Шлях до зрілості?', opts: ['Уникати рішень', 'Прийняти відповідальність за життя', 'Залишатися дитиною'], c: 1 }
    ]},
    { id: 6, title: 'Урок 5: Не будь важливим', description: 'Страх привертати увагу, відчуття незначущості', videoUrl: 'https://www.youtube.com/embed/10oQBICrIjc', duration: '13:00', points: 25, quiz: [
        { q: 'Що таке комплекс Йони?', opts: ['Страх публічних виступів', 'Страх власного успіху та величі', 'Страх темряви'], c: 1 },
        { q: 'Коли найчастіше проявляється саботаж?', opts: ['На фінішній прямій', 'На початку', 'В середині'], c: 0 },
        { q: 'Чому батьки блокували успіх?', opts: ['З радості', 'Із заздрості', 'Із страху за дитину'], c: 2 },
        { q: 'Типова поведінка?', opts: ['Святкувати перемоги', 'Зупинятися перед успіхом', 'Досягати цілей'], c: 1 },
        { q: 'Нова установка?', opts: ['Я маю право на успіх', 'Успіх небезпечний', 'Треба бути скромним'], c: 0 }
    ]},
    { id: 7, title: 'Урок 6: Не думай + Рефреймінг', description: 'Заборона на мислення. Теорія та шестишаговий рефреймінг', videoUrl: 'https://www.youtube.com/embed/Prbt3xNKH-k', videoUrl2: 'https://www.youtube.com/embed/wbKKNIIvTKk', duration: '25:00', points: 25, quiz: [
        { q: 'Як людина з директивою Не будь важливим поводиться в колективі?', opts: ['Завжди прагне бути лідером', 'Уникає уваги та публічних виступів', 'Постійно сперечається'], c: 1 },
        { q: 'Типова фраза дитинства?', opts: ['Ти зірка', 'Не висовуйся', 'Будь лідером'], c: 1 },
        { q: 'Основне відчуття?', opts: ['Значущість', 'Впевненість', 'Незначущість'], c: 2 },
        { q: 'Як проявляється в кар\'єрі?', opts: ['Активність', 'Відмова від просування', 'Швидке зростання'], c: 1 },
        { q: 'Що допомагає?', opts: ['Дозволити собі бути видимим', 'Ховатися далі', 'Мовчати завжди'], c: 0 }
    ]},
    { id: 8, title: 'Урок 7: Не будь близько', description: 'Проблеми у стосунках, відштовхування партнера, страх емоційної залежності', videoUrl: 'https://www.youtube.com/embed/nxn-1FvVbkc', duration: '11:45', points: 25, quiz: [
        { q: 'Який механізм захисту найчастіше використовується при директиві Не будь близько?', opts: ['Інтелектуалізація', 'Відсторонення/Відчуження', 'Раціоналізація'], c: 1 },
        { q: 'Що відбувається при наближенні партнера?', opts: ['Спокій', 'Автоматичне відштовхування', 'Радість'], c: 1 },
        { q: 'Типова фраза з дитинства?', opts: ['Я тебе люблю', 'Не підходь до мене', 'Обійми мене'], c: 1 },
        { q: 'Паттерн стосунків?', opts: ['Близькість-відштовхування', 'Стабільність', 'Гармонія'], c: 0 },
        { q: 'Шлях до близькості?', opts: ['Бути холодним', 'Усвідомити страх і працювати з ним', 'Уникати стосунків'], c: 1 }
    ]},
    { id: 9, title: 'Урок 8: Не взрослій + Опрацювання', description: 'Інфантилізм, страх відповідальності. Теорія та опрацювання', videoUrl: 'https://www.youtube.com/embed/bAH42svX7nQ', videoUrl2: 'https://www.youtube.com/embed/bAH42svX7nQ', duration: '30:00', points: 25, quiz: [
        { q: 'Фрази формування?', opts: ['Ти вже не дитина, хватит ныть!', 'Грай скільки хочеш', 'Будь собою'], c: 0 },
        { q: 'Чому втома?', opts: ['Багато роботи', 'Блокується спонтанність та енергія', 'Немає відпочинку'], c: 1 },
        { q: 'Як проявляється?', opts: ['Радість', 'Вина за відпочинок, гіперконтроль', 'Легкість'], c: 1 },
        { q: 'Мета вправи?', opts: ['Повернення контакту з внутрішньою дитиною', 'Аналіз', 'Планування'], c: 0 },
        { q: 'Новий вибір?', opts: ['Ти маєш право бути ребёнком', 'Будь серйознішим', 'Контролюй себе'], c: 0 }
    ]},
    { id: 10, title: 'Урок 9: Не належ', description: 'Відчуття чужинця, ізоляція, проблеми з інтеграцією', videoUrl: 'https://www.youtube.com/embed/lFamCfeEK4M', duration: '20:00', points: 25, quiz: [
        { q: 'Основа страху?', opts: ['Історичні травми роду', 'Лінь', 'Відсутність освіти'], c: 0 },
        { q: 'Чому саботаж?', opts: ['Страх втратити любов', 'Не вміє', 'Немає цілей'], c: 0 },
        { q: 'Що чує дитина?', opts: ['Підтримка', 'Любов', 'Успіх небезпечний'], c: 2 },
        { q: 'Мета вправи?', opts: ['Заробити', 'Усвідомити чого боїшся', 'Знайти роботу'], c: 1 },
        { q: 'Нова установка?', opts: ['Успіх безпечний', 'Не висовуйся', 'Будь скромним'], c: 0 }
    ]},
    { id: 11, title: 'Урок 10: Не відчувай', description: 'Блокування емоцій, нездатність до емпатії, алекситимія', videoUrl: 'https://www.youtube.com/embed/9Gx2nNVB-9o', duration: '25:00', points: 25, quiz: [
        { q: 'Фрази?', opts: ['Веди за собою', 'Ти лідер!', 'Сиди тихо!'], c: 2 },
        { q: 'Чому боїться сцени?', opts: ['Скромність', 'Страх осуду та стыд', 'Інтроверт'], c: 1 },
        { q: 'Синдром другого?', opts: ['Самотність', 'Комфортно поруч, але не бути', 'Завжди лідер'], c: 1 },
        { q: 'Мета вправи?', opts: ['Стати президентом', 'Навчитися керувати', 'Усвідомити лідерство'], c: 2 },
        { q: 'Новий вибір?', opts: ['Будь непомітним', 'Лідер — це той, хто веде світло', 'Мовчи'], c: 1 }
    ]},
    { id: 12, title: 'Урок 11: Не будь здоровим', description: 'Психосоматичні розлади, хронічні болі, хвороба як спосіб отримати любов', videoUrl: 'https://www.youtube.com/embed/jLrXDhy1tGw', duration: '22:00', points: 25, quiz: [
        { q: 'Фрази?', opts: ['Нікому не можна вірити!', 'Довіряй людям', 'Відкривайся'], c: 0 },
        { q: 'Чому передає тривогу?', opts: ['Любить', 'Сам був зраджений', 'Хоче добра'], c: 1 },
        { q: 'Як проявляється?', opts: ['Дистанція, контроль', 'Відкритість', 'Тепло'], c: 0 },
        { q: 'Мета вправ?', opts: ['Закритися', 'Усвідомити захист', 'Знайти ворога'], c: 1 },
        { q: 'Нова установка?', opts: ['Близькість — це зрілість серця', 'Всі брешуть', 'Довіра = наївність'], c: 0 }
    ]},
    { id: 13, title: 'Урок 12: Не будь дитиною', description: 'Перевантаження відповідальністю, синдром батька, парентифікація', videoUrl: 'https://www.youtube.com/embed/XvMt319h6Ok', duration: '24:00', points: 25, quiz: [
        { q: 'Послання?', opts: ['Ти моя єдина опора', 'Ти частина нас', 'Знаходь друзів'], c: 0 },
        { q: 'Чому поза колом?', opts: ['Характер', 'Контракт належати = зрадити', 'Погана компанія'], c: 1 },
        { q: 'Тепло = контроль?', opts: ['Любов вільна', 'Близькість через залежність', 'Дружба легка'], c: 1 },
        { q: 'Мета вправи?', opts: ['Стати лідером', 'Уникнути людей', 'Відчути право на приналежність'], c: 2 },
        { q: 'Новий вибір?', opts: ['Приналежність — не втрата себе', 'Я один', 'Люди небезпечні'], c: 0 }
    ]},
    { id: 14, title: 'Поле Ресурсів', description: 'Практика відновлення внутрішньої сили та енергії', videoUrl: 'https://www.youtube.com/embed/cuARoXSQQvU', duration: '18:00', points: 25, quiz: [
        { q: 'Що таке поле?', opts: ['Внутрішній простір відновлення', 'Фізичне місце', 'Гроші'], c: 0 },
        { q: 'Скільки зон?', opts: ['Три', 'П\'ять (тіло, емоції, стосунки, справи, дух)', 'Одну'], c: 1 },
        { q: 'Як зрозуміти втрату?', opts: ['Аналіз', 'Сканування відчуттів у тілі', 'Здогад'], c: 1 },
        { q: 'Мета?', opts: ['Розслабитись', 'Знайти витоки сили', 'Відпочити'], c: 1 },
        { q: 'Коли робити?', opts: ['Щодня чи при втраті сил', 'Ніколи', 'Раз на рік'], c: 0 }
    ]},
    { id: 15, title: 'ІМАГО: Теорія стосунків', description: 'Як підсвідомість обирає партнерів та створює сценарії', videoUrl: 'https://www.youtube.com/embed/ZsKv9NDwpt8', duration: '35:00', points: 25, quiz: [
        { q: 'Що таке ІМАГО?', opts: ['Ідеал', 'Образ батьків у підсвідомості', 'Мрія'], c: 1 },
        { q: 'Чому схожі люди?', opts: ['Намагаємось дозцілити дитячі рани', 'Випадковість', 'Доля'], c: 0 },
        { q: 'Стадії стосунків?', opts: ['Тільки закоханість', 'Закоханість, боротьба, усвідомленість', 'Одна'], c: 1 },
        { q: 'Мета теорії?', opts: ['Усвідомити проекції', 'Розлучитись', 'Нічого'], c: 0 },
        { q: 'Що з проекціями?', opts: ['Ігнорувати', 'Помічати, приймати, працювати', 'Звинувачувати'], c: 1 }
    ]},
    { id: 16, title: 'Завершення: Інтеграція та Новий Сценарій', description: 'Як інтегрувати нові установки та жити відповідно до власного Дорослого стану', videoUrl: 'https://www.youtube.com/embed/wmaRjk2aK3E', duration: '18:10', points: 25, quiz: [
        { q: 'Де зберігаються?', opts: ['В розумі', 'В тілі та м\'язовій пам\'яті', 'В словах'], c: 1 },
        { q: 'Психосоматика?', opts: ['Хвороба тіла від психіки', 'Інфекція', 'Спадковість'], c: 0 },
        { q: 'Ефективна практика?', opts: ['Тільки роздуми', 'Тілесна терапія', 'Читання'], c: 1 },
        { q: 'Техніка?', opts: ['Аналіз', 'Усвідомлення відчуттів', 'Ігнорування тіла'], c: 1 },
        { q: 'Дихання допомагає?', opts: ['Ні', 'Так, розслабляє', 'Тільки іноді'], c: 1 }
    ]}
];
const ADMIN_CODE = 'ADMIN2025';

let currentUser = null;
let completed = new Set();
let currentScreen = 'register';
let totalScore = 0;
let aiMessages = [];
let isAdmin = false;

async function sendWelcomeEmail(email, name) {
    const apiUrl = window.HATCH_CONFIG ? `${window.HATCH_CONFIG.apiBaseUrl}/services/send_email` : '/services/send_email';
    
    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                email: email,
                message: `Вітаємо, ${name}!

🎉 Ви успішно зареєстровані на курсі "Батьківські директиви"!

📚 Курс містить:
• 16 відео-уроків
• 85 питань для самоперевірки
• 425 балів для отримання
• Сертифікат після завершення

Успіхів у навчанні!

З повагою,
Команда "Батьківські директиви"`
            })
        });
        
        return response.ok;
    } catch (error) {
        console.error('Помилка відправки email:', error);
        return false;
    }
}

function register() {
    const name = document.getElementById('register-name').value.trim();
    const email = document.getElementById('register-email').value.trim();
    
    if (!name || !email) {
        alert('Будь ласка, заповніть всі поля');
        return;
    }
    
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        alert('Будь ласка, введіть коректний email');
        return;
    }
    
    const password = document.getElementById('register-password').value.trim();
    const confirmPassword = document.getElementById('register-password-confirm').value.trim();
    
    if (!password || !confirmPassword) {
        alert('Будь ласка, введіть пароль');
        return;
    }
    
    if (password !== confirmPassword) {
        alert('Паролі не співпадають!');
        return;
    }
    
    if (password.length < 6) {
        alert('Пароль має бути мінімум 6 символів');
        return;
    }
    
    const existingUser = localStorage.getItem('user_' + email);
    if (existingUser) {
        alert('Користувач з таким email вже існує!');
        return;
    }
    
    const user = {
        name,
        email,
        password,
        completed: [],
        score: 0,
        workbook: '',
        finalExamPassed: false,
        registeredAt: new Date().toISOString()
    };
    
    localStorage.setItem('user_' + email, JSON.stringify(user));
    currentUser = user;
    
    document.getElementById('welcome-name').textContent = name;
    document.getElementById('welcome-email').textContent = email;
    
    alert('🎉 Реєстрація успішна!\n\nВітаємо на курсі "Батьківські директиви"!\n\n📚 Курс містить:\n• 17 відео-уроків\n• 85 питань для самоперевірки\n• 425 балів для отримання\n• Сертифікат після завершення\n\nУспіхів у навчанні!');
    
    sendWelcomeEmail(email, name).catch(() => {});
    
    showScreen('welcome');
}

function login() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value.trim();
    
    if (!email || !password) {
        alert('Введіть email та пароль');
        return;
    }
    
    const userData = localStorage.getItem('user_' + email);
    if (!userData) {
        alert('Користувача не знайдено.');
        return;
    }
    
    const user = JSON.parse(userData);
    
    if (user.password !== password) {
        alert('Невірний пароль!');
        return;
    }
    
    currentUser = user;
    completed = new Set(currentUser.completed || []);
    totalScore = currentUser.score || 0;
    
    document.getElementById('welcome-name').textContent = currentUser.name;
    document.getElementById('welcome-email').textContent = currentUser.email;
    
    if (currentUser.workbook) {
        document.getElementById('workbook-text').value = currentUser.workbook;
    }
    
    showScreen('welcome');
}

function showProfile() {
    if (!currentUser) return;
    
    const progress = completed.size;
    const certificateStatus = progress === 16 ? '🎓 Сертифікат отриманий!' : `📊 Прогрес: ${progress}/16 уроків`;
    
    alert(`👤 Профіль\n\n` +
          `Ім'я: ${currentUser.name}\n` +
          `Email: ${currentUser.email}\n\n` +
          `${certificateStatus}\n` +
          `💯 Загальний бал: ${totalScore}`);
}

function logout() {
    if (confirm('Ви впевнені, що хочете вийти?')) {
        currentUser = null;
        completed = new Set();
        totalScore = 0;
        showScreen('login');
    }
}

function saveWorkbook() {
    if (!currentUser) return;
    
    const text = document.getElementById('workbook-text').value;
    currentUser.workbook = text;
    localStorage.setItem('user_' + currentUser.email, JSON.stringify(currentUser));
    alert('💾 Нотатки збережено!');
}

function toggleAI() {
    const ai = document.getElementById('ai-assistant');
    ai.classList.toggle('hidden');
    if (!ai.classList.contains('hidden') && aiMessages.length === 0) {
        addAIMessage('assistant', 'Привіт! Я ваш ШІ помічник. Я можу відповісти на питання про батьківські директиви, допомогти розібратись з уроками та підтримати вас на шляху трансформації. Як можу допомогти?');
    }
}

function addAIMessage(role, content) {
    const chatDiv = document.getElementById('ai-chat');
    const msgDiv = document.createElement('div');
    msgDiv.className = 'message ' + role;
    msgDiv.textContent = content;
    chatDiv.appendChild(msgDiv);
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

async function sendAIMessage() {
    const input = document.getElementById('ai-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    addAIMessage('user', message);
    input.value = '';
    
    aiMessages.push({ role: 'user', content: message });
    
    const thinkingDiv = document.createElement('div');
    thinkingDiv.className = 'message assistant';
    thinkingDiv.textContent = '💭 Думаю...';
    thinkingDiv.id = 'thinking';
    document.getElementById('ai-chat').appendChild(thinkingDiv);
    
    try {
        const response = await fetch('https://inviz-threads.phil-1879nlp.workers.dev/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: 'gpt-4',
                messages: [
                    { role: 'system', content: 'Ти — КураШІ (куратор на основі ШІ) — психолог і психотерапевт з понад 20-річним досвідом роботи, спеціалізуєшся на аналізі й трансформації батьківських директив за Ерiком Берном, у поєднанні з ІМАГО-підходом (Harville Hendrix). Ти не просто чат-бот, а терапевтичний провідник. Твоя задача — допомогти людині усвідомити, звідки у неї з’явилися обмежувальні сценарії, навчити бачити їх у повсякденних реакціях і дати безпечний шлях до трансформації.Тон і стиль спілкування: Емпатійний, теплий, без осуду. Професійний, спокійний, але живий.Мова за замовчуванням — українська, але, якщо людина спілкується іншою мовою - ти відразу переключаєшься на її мову. Уникає штампів і банальних фраз. Говорить просто про складне, з прикладами. Використовує метафори: “ниті сценаріїв”, “внутрішня дитина”, “дзеркало ІМАГО”. Підтримує гідність користувача, не вчить, а веде поруч. Завдання асистента: Пояснює суть кожної з 12 директив (по черзі або за запитом): “Не живи”, “Не будь собою”, “Не думай”, “Не відчувай”, “Не будь дитиною”, “Не будь здоровим”, “Не будь успішним”, “Не будь близьким”, “Не будь значимим”, “Не належи нікому”, “Не роби”, “Не будь у своїй ролі”. Розкриває: Як директива формується у дитинстві; Як проявляється у дорослому житті; Як вона впливає на стосунки, роботу, здоров’я; Як пов’язана з ІМАГО-механізмом вибору партнера. Пропонує вправи для усвідомлення та проработки: письмові (щоденникові запитання, “діалог із дитиною”); тілесні (дихання, контакт із відчуттями); символічні (візуалізація нитей, очищення, прощення). Дає користувачу зворотний зв’язок і підтримку — не оцінює, а відображає: “Ти зробив важливий крок — побачив сценарій. Це вже частина зцілення.” Пояснює зв’язок директив із внутрішньою дитиною та партнерськими стосунками (ІМАГО). В кінці кожного етапу м’яко запрошує користувача продовжити курс або перейти до наступного уроку. Приклади поведінки: Коли користувач питає: “Мені здається, що я не можу розслабитись навіть у стосунках. Асистент відповідає: “Можливо, у тобі звучить директива «Не будь близьким» Її часто передають батьки, які самі боялись довіри. Вони навчали: ‘Будь обережним, не відкривайся — і не постраждаєш’. Але без близькості немає тепла. Давай подивимось, коли ти вперше відчув, що бути щирим небезпечно?” Коли користувач каже: “Я часто хворію перед важливими подіями.” Асистент: “Тут може діяти директива «Не будь здоровим». Дитині часто давали більше любові, коли вона хворіла, і вона несвідомо пов’язала турботу з хворобою. Давай знайдемо, як зараз можна дати собі цю турботу — без болю.” Алгоритм роботи: Вітання → коротке пояснення курсу. Запит: яку директиву хочеш дослідити? Аналіз → пояснення механізму. Рефлексія → запитання користувачу.Практика → вправа або візуалізація. Підтримка → фраза про прийняття й крок уперед. Пропозиція → “Хочеш перейти до наступного розділу курсу?” Додатково: Асистент пам’ятає, на якій директиві користувач зупинився. Може коротко підсумувати попередній урок.При потребі створює медитацію або трансову техніку для глибшої роботи. Може інтегрувати ІМАГО: пояснює, як кожна директива впливає на вибір партнера й любовні сценарії.' },
                    ...aiMessages
                ],
                max_tokens: 500,
                temperature: 0.7
            })
        });
        
        document.getElementById('thinking').remove();
        
        if (response.ok) {
            const data = await response.json();
            const reply = data.choices[0].message.content;
            aiMessages.push({ role: 'assistant', content: reply });
            addAIMessage('assistant', reply);
        } else {
            addAIMessage('assistant', '❌ Вибачте, виникла помилка. Спробуйте ще раз.');
        }
    } catch (error) {
        document.getElementById('thinking')?.remove();
        addAIMessage('assistant', '❌ Помилка зв\'язку з сервером.');
    }
}

function showScreen(name) {
    document.querySelectorAll('[id^="screen-"]').forEach(el => el.classList.add('hidden'));
    document.getElementById('screen-' + name).classList.remove('hidden');
    currentScreen = name;
    if (name === 'dashboard') {
        renderLessons();
        updateUnreadBadge();
    }
}

function renderLessons() {
    const container = document.getElementById('lessons-container');
    container.innerHTML = lessons.map(l => {
        const done = completed.has(l.id);
        const isLocked = l.id > 1 && !completed.has(l.id - 1);
        const canAccess = !isLocked || done;
        
        return `
        <div class="bg-white rounded-xl p-6 shadow ${canAccess ? 'hover:shadow-lg cursor-pointer' : 'opacity-50 cursor-not-allowed'} transition ${done ? 'border-2 border-green-500' : isLocked ? 'border-2 border-gray-300' : ''}" onclick="${canAccess ? 'showLesson(' + l.id + ')' : 'alert(\'Спочатку завершіть попередній урок та здайте тест!\')'}">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-sm font-bold text-blue-600">Урок ${l.id}</span>
                        ${done ? '<span class="text-green-600">✓ Завершено</span>' : isLocked ? '<span class="text-gray-400">🔒 Заблоковано</span>' : '<span class="text-orange-500">Доступно</span>'}
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${l.title}</h3>
                    <p class="text-gray-600 mb-3">${l.description}</p>
                    <div class="flex items-center gap-4 text-sm text-gray-500">
                        <span>⏱️ ${l.duration}</span>
                        <span>📝 ${l.quiz.length} питань</span>
                        <span>⭐ ${l.points} балів</span>
                    </div>
                </div>
            </div>
        </div>
        `;
    }).join('');
    document.getElementById('progress').textContent = completed.size;
}

window.showLesson = function(id) {
    const lesson = lessons.find(l => l.id === id);
    const content = document.getElementById('lesson-content');
    
    const videoId1 = lesson.videoUrl.split('/').pop().split('?')[0];
    const videoId2 = lesson.videoUrl2 ? lesson.videoUrl2.split('/').pop().split('?')[0] : null;
    
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isSlowConnection = navigator.connection && (navigator.connection.effectiveType === 'slow-2g' || navigator.connection.effectiveType === '2g' || navigator.connection.effectiveType === '3g');
    const videoQuality = (isMobile || isSlowConnection) ? 'modest' : 'high';
    const autoplay = (!isMobile && !isSlowConnection) ? '&autoplay=0' : '';
    
    const videoParams = `?enablejsapi=1&modestbranding=1&rel=0&playsinline=1&quality=${videoQuality}${autoplay}`;
    
    const mobileWarning = (isMobile || isSlowConnection) ? `
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
            <div class="flex items-center gap-2">
                <span class="text-2xl">📱</span>
                <div>
                    <div class="font-bold text-blue-800">Оптимізовано для мобільного</div>
                    <div class="text-sm text-blue-700">Відео завантажується в низькій якості для економії трафіку</div>
                </div>
            </div>
        </div>
    ` : '';
    
    const videoSection = mobileWarning + (lesson.videoUrl2 ? `
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
            <div class="p-6 border-b">
                <div class="text-sm font-bold text-blue-600 mb-2">Урок ${lesson.id} - Частина 1: Теорія</div>
                <h2 class="text-3xl font-black text-gray-800">${lesson.title}</h2>
            </div>
            <div class="video-container" id="video-container-${lesson.id}-1">
                <iframe id="video-${lesson.id}-1" src="${lesson.videoUrl}${videoParams}" frameborder="0" allowfullscreen loading="lazy"></iframe>
            </div>
            <div class="p-4 flex items-center justify-between bg-gray-50">
                <div id="video-status-${lesson.id}-1" class="text-sm text-gray-500">⏳ Завантаження відео...</div>
                <button onclick="reportVideoIssue(${lesson.id}, '${videoId1}', 1)" class="text-xs text-red-600 hover:text-red-800 hover:underline">⚠️ Повідомити про проблему</button>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
            <div class="p-6 border-b">
                <div class="text-sm font-bold text-purple-600 mb-2">Урок ${lesson.id} - Частина 2: Проробка</div>
                <h2 class="text-2xl font-bold text-gray-800">Практичні вправи</h2>
            </div>
            <div class="video-container" id="video-container-${lesson.id}-2">
                <iframe id="video-${lesson.id}-2" src="${lesson.videoUrl2}${videoParams}" frameborder="0" allowfullscreen loading="lazy"></iframe>
            </div>
            <div class="p-4 flex items-center justify-between bg-gray-50">
                <div id="video-status-${lesson.id}-2" class="text-sm text-gray-500">⏳ Завантаження відео...</div>
                <button onclick="reportVideoIssue(${lesson.id}, '${videoId2}', 2)" class="text-xs text-red-600 hover:text-red-800 hover:underline">⚠️ Повідомити про проблему</button>
            </div>
        </div>
    ` : `
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
            <div class="p-6 border-b">
                <div class="text-sm font-bold text-blue-600 mb-2">Урок ${lesson.id}</div>
                <h2 class="text-3xl font-black text-gray-800">${lesson.title}</h2>
            </div>
            <div class="video-container" id="video-container-${lesson.id}-1">
                <iframe id="video-${lesson.id}-1" src="${lesson.videoUrl}${videoParams}" frameborder="0" allowfullscreen loading="lazy"></iframe>
            </div>
            <div class="p-4 flex items-center justify-between bg-gray-50">
                <div id="video-status-${lesson.id}-1" class="text-sm text-gray-500">⏳ Завантаження відео...</div>
                <button onclick="reportVideoIssue(${lesson.id}, '${videoId1}', 1)" class="text-xs text-red-600 hover:text-red-800 hover:underline">⚠️ Повідомити про проблему</button>
            </div>
        </div>
    `);
    
    content.innerHTML = videoSection + `
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-2xl font-bold mb-6">Тест після уроку</h3>
            ${lesson.quiz.map((q, i) => `
                <div class="mb-6 pb-6 border-b last:border-0">
                    <p class="font-semibold mb-3">${i + 1}. ${q.q}</p>
                    ${q.opts.map((opt, j) => `
                        <label class="block p-4 border-2 rounded-lg mb-2 cursor-pointer hover:bg-blue-50 transition">
                            <input type="radio" name="q${i}" value="${j}" class="mr-2"> ${opt}
                        </label>
                    `).join('')}
                </div>
            `).join('')}
            <button onclick="checkAnswers(${lesson.id})" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-4 rounded-xl hover:shadow-xl transition">
                Перевірити відповіді
            </button>
        </div>
    `;
    showScreen('lesson');
    setTimeout(() => monitorVideoLoad(lesson.id, videoId1, videoId2), 500);
    
    if (isMobile || isSlowConnection) {
        console.log(`📱 Мобільний режим: ${isMobile ? 'так' : 'ні'}, Повільне зв'язок: ${isSlowConnection ? 'так' : 'ні'}`);
    }
};

function monitorVideoLoad(lessonId, videoId1, videoId2) {
    const checkVideo = (vidNum, videoId) => {
        const iframe = document.getElementById(`video-${lessonId}-${vidNum}`);
        const statusEl = document.getElementById(`video-status-${lessonId}-${vidNum}`);
        
        if (!iframe || !statusEl) return;
        
        let loadTimeout = setTimeout(() => {
            if (statusEl.textContent.includes('Завантаження')) {
                statusEl.innerHTML = '<span class="text-orange-600">⚠️ Відео завантажується повільно...</span>';
                logVideoError(lessonId, videoId, 'slow_load', vidNum);
            }
        }, 5000);
        
        iframe.addEventListener('load', () => {
            clearTimeout(loadTimeout);
            statusEl.innerHTML = '<span class="text-green-600">✅ Відео готове до перегляду</span>';
        });
        
        iframe.addEventListener('error', () => {
            clearTimeout(loadTimeout);
            statusEl.innerHTML = '<span class="text-red-600">❌ Помилка завантаження відео</span>';
            logVideoError(lessonId, videoId, 'load_error', vidNum);
        });
    };
    
    checkVideo(1, videoId1);
    if (videoId2) checkVideo(2, videoId2);
}

function logVideoError(lessonId, videoId, errorType, partNum) {
    const errorLog = {
        timestamp: new Date().toISOString(),
        lessonId: lessonId,
        videoId: videoId,
        partNum: partNum,
        errorType: errorType,
        userEmail: currentUser ? currentUser.email : 'anonymous',
        userName: currentUser ? currentUser.name : 'anonymous',
        userAgent: navigator.userAgent,
        url: window.location.href
    };
    
    let errorLogs = JSON.parse(localStorage.getItem('video_error_logs') || '[]');
    errorLogs.push(errorLog);
    if (errorLogs.length > 500) errorLogs = errorLogs.slice(-500);
    localStorage.setItem('video_error_logs', JSON.stringify(errorLogs));
    
    console.warn('Video Error Logged:', errorLog);
}

window.reportVideoIssue = function(lessonId, videoId, partNum) {
    const issue = prompt('Опишіть проблему з відео (наприклад: "не відтворюється", "чорний екран", "помилка 153"):');
    if (!issue) return;
    
    const errorLog = {
        timestamp: new Date().toISOString(),
        lessonId: lessonId,
        videoId: videoId,
        partNum: partNum,
        errorType: 'user_reported',
        issue: issue,
        userEmail: currentUser ? currentUser.email : 'anonymous',
        userName: currentUser ? currentUser.name : 'anonymous',
        userAgent: navigator.userAgent,
        url: window.location.href
    };
    
    let errorLogs = JSON.parse(localStorage.getItem('video_error_logs') || '[]');
    errorLogs.push(errorLog);
    localStorage.setItem('video_error_logs', JSON.stringify(errorLogs));
    
    alert('Дякуємо за повідомлення! Ми отримали інформацію про проблему і працюємо над її вирішенням.');
};

window.checkAnswers = function(lessonId) {
    const lesson = lessons.find(l => l.id === lessonId);
    let correct = 0;
    lesson.quiz.forEach((q, i) => {
        const selected = document.querySelector(`input[name="q${i}"]:checked`);
        if (selected && parseInt(selected.value) === q.c) correct++;
    });
    
    const minCorrect = Math.ceil(lesson.quiz.length * 0.6);
    const score = Math.round((correct / lesson.quiz.length) * lesson.points);
    
    if (correct >= minCorrect) {
        completed.add(lessonId);
        totalScore += score;
        
        if (currentUser) {
            currentUser.completed = Array.from(completed);
            currentUser.score = totalScore;
            localStorage.setItem('user_' + currentUser.email, JSON.stringify(currentUser));
        }
        
        if (completed.size === lessons.length) {
            alert(`🎉 ВІТАЄМО! ВИ ЗАВЕРШИЛИ ВЕСЬ КУРС!\n\nПравильних відповідей: ${correct} з ${lesson.quiz.length}\nНабрано балів: ${score} з ${lesson.points}\n\nЗагальна кількість балів: ${totalScore}\n\nЗараз ви побачите ваш сертифікат!`);
            showCertificate();
        } else {
            alert(`🎉 Вітаємо!\n\nПравильних відповідей: ${correct} з ${lesson.quiz.length}\nНабрано балів: ${score} з ${lesson.points}\n\nУрок завершено! Наступний урок розблоковано.`);
            sendLessonCompletionEmail(lessonId);
            showScreen('dashboard');
        }
    } else {
        alert(`Правильних відповідей: ${correct} з ${lesson.quiz.length}\nПотрібно мінімум ${minCorrect} правильних відповідей для завершення уроку.\nСпробуйте ще раз!`);
    }
};

function showCertificate() {
    if (!currentUser) return;
    
    document.getElementById('modal-certificate-name').classList.remove('hidden');
}

function generateCertificate() {
    const fullName = document.getElementById('cert-full-name').value.trim();
    
    if (!fullName || fullName.split(' ').length < 2) {
        alert('Будь ласка, введіть прізвище та ім\'я');
        return;
    }
    
    let totalHours = 0;
    lessons.forEach(lesson => {
        const duration = lesson.duration || '00:00';
        const [minutes, seconds] = duration.split(':').map(Number);
        totalHours += (minutes || 0) + (seconds || 0) / 60;
    });
    
    const hours = Math.round(totalHours / 60 * 10) / 10;
    const certId = generateCertificateId();
    
    document.getElementById('cert-name').textContent = fullName;
    document.getElementById('cert-score').textContent = totalScore;
    document.getElementById('cert-hours').textContent = hours;
    document.getElementById('cert-date').textContent = new Date().toLocaleDateString('uk-UA', { year: 'numeric', month: 'long', day: 'numeric' });
    document.getElementById('cert-id').textContent = certId;
    
    if (currentUser) {
        currentUser.certificateId = certId;
        currentUser.certificateName = fullName;
        localStorage.setItem('user_' + currentUser.email, JSON.stringify(currentUser));
    }
    
    generateQRCode(certId, fullName);
    
    document.getElementById('modal-certificate-name').classList.add('hidden');
    showScreen('certificate');
}

function generateCertificateId() {
    return 'CERT-' + Date.now().toString(36).toUpperCase() + '-' + Math.random().toString(36).substring(2, 7).toUpperCase();
}

function generateQRCode(certId, fullName) {
    const canvas = document.getElementById('cert-qrcode');
    const verificationUrl = window.location.origin + window.location.pathname + '?verify=' + certId;
    const qrData = JSON.stringify({
        id: certId,
        name: fullName,
        course: 'Батьківські директиви',
        date: new Date().toISOString(),
        score: totalScore
    });
    
    QRCode.toCanvas(canvas, qrData, {
        width: 96,
        margin: 1,
        color: {
            dark: '#667eea',
            light: '#ffffff'
        }
    });
}

async function downloadCertificatePNG() {
    const certificate = document.getElementById('certificate');
    
    try {
        const canvas = await html2canvas(certificate, {
            scale: 2,
            backgroundColor: null,
            logging: false,
            useCORS: true
        });
        
        const link = document.createElement('a');
        link.download = 'Сертифікат_' + document.getElementById('cert-id').textContent + '.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    } catch (error) {
        alert('Помилка при завантаженні. Спробуйте ще раз.');
    }
}

async function downloadCertificatePDF() {
    const certificate = document.getElementById('certificate');
    
    try {
        const canvas = await html2canvas(certificate, {
            scale: 2,
            backgroundColor: null,
            logging: false,
            useCORS: true
        });
        
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a4'
        });
        
        const imgWidth = 297;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
        pdf.save('Сертифікат_' + document.getElementById('cert-id').textContent + '.pdf');
    } catch (error) {
        alert('Помилка при завантаженні. Спробуйте ще раз.');
    }
}

function adminLogin() {
    const code = document.getElementById('admin-code-input').value.trim();
    
    if (code === ADMIN_CODE) {
        isAdmin = true;
        loadAdminPanel();
        showScreen('admin');
    } else {
        alert('❌ Невірний адмін-код!');
    }
}

function adminLogout() {
    if (confirm('Вийти з адмін-панелі?')) {
        isAdmin = false;
        showScreen('login');
    }
}

function loadAdminPanel() {
    const users = [];
    
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('user_')) {
            try {
                const userData = JSON.parse(localStorage.getItem(key));
                users.push(userData);
            } catch (e) {}
        }
    }
    
    const totalUsers = users.length;
    const completedUsers = users.filter(u => u.completed && u.completed.length === 16).length;
    const activeUsers = users.filter(u => u.completed && u.completed.length > 0 && u.completed.length < 16).length;
    
    document.getElementById('admin-total-users').textContent = totalUsers;
    document.getElementById('admin-completed').textContent = completedUsers;
    document.getElementById('admin-active').textContent = activeUsers;
    
    renderUsersTable(users);
    refreshVideoErrorLogs();
}

function renderUsersTable(users) {
    const tbody = document.getElementById('admin-users-table');
    
    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">Немає зареєстрованих користувачів</td></tr>';
        return;
    }
    
    users.sort((a, b) => new Date(b.registeredAt) - new Date(a.registeredAt));
    
    tbody.innerHTML = users.map(user => {
        const progress = user.completed ? user.completed.length : 0;
        const progressPercent = Math.round((progress / 16) * 100);
        const score = user.score || 0;
        const date = new Date(user.registeredAt).toLocaleDateString('uk-UA');
        
        const messages = getMessages(user.email);
        const unreadCount = messages.filter(m => m.sender === 'user' && !m.read).length;
        const unreadBadge = unreadCount > 0 ? `<span class="inline-block ml-1 px-1.5 py-0.5 bg-red-500 text-white text-xs rounded-full">${unreadCount}</span>` : '';
        
        const lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;
        const lastMessageTime = lastMessage ? new Date(lastMessage.timestamp).toLocaleString('uk-UA', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';
        const lastMessagePreview = lastMessage ? `<div class="text-xs text-gray-500 mt-1">${lastMessage.sender === 'user' ? '👤' : '👑'} ${lastMessageTime}</div>` : '';
        
        return `
            <tr class="border-b hover:bg-gray-50">
                <td class="py-3 px-4">${user.name}</td>
                <td class="py-3 px-4 text-sm">${user.email}</td>
                <td class="py-3 px-4 text-center">
                    <div class="flex items-center justify-center gap-2">
                        <div class="text-sm font-bold">${progress}/16</div>
                        <div class="text-xs text-gray-500">(${progressPercent}%)</div>
                    </div>
                </td>
                <td class="py-3 px-4 text-center font-bold text-purple-600">${score}</td>
                <td class="py-3 px-4 text-center text-sm text-gray-600">${date}</td>
                <td class="py-3 px-4 text-center">
                    <div class="flex items-center justify-center gap-2">
                        <button onclick="openAdminChat('${user.email}')" class="text-blue-600 hover:text-blue-800 text-sm font-semibold relative" title="Написати повідомлення">💬${unreadBadge}</button>
                        <button onclick="deleteUser('${user.email}')" class="text-red-600 hover:text-red-800 text-sm font-semibold" title="Видалити">🗑️</button>
                    </div>
                    ${lastMessagePreview}
                </td>
            </tr>
        `;
    }).join('');
}

function filterUsers() {
    const search = document.getElementById('admin-search').value.toLowerCase();
    const users = [];
    
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('user_')) {
            try {
                const userData = JSON.parse(localStorage.getItem(key));
                users.push(userData);
            } catch (e) {}
        }
    }
    
    const filtered = users.filter(user => 
        user.name.toLowerCase().includes(search) ||
        user.callsign.toLowerCase().includes(search) ||
        user.code.toLowerCase().includes(search) ||
        user.email.toLowerCase().includes(search)
    );
    
    renderUsersTable(filtered);
}

function deleteUser(email) {
    if (confirm('Ви впевнені, що хочете видалити цього користувача?')) {
        localStorage.removeItem('user_' + email);
        loadAdminPanel();
        alert('✅ Користувача видалено!');
    }
}

function showLegalDoc(type) {
    const titles = {
        privacy: 'Політика конфіденційності',
        disclaimer: 'Відмова від відповідальності',
        terms: 'Договір публічної оферти'
    };
    
    const contents = {
        privacy: `
            <h3 class="text-xl font-bold mb-4">1. Загальні положення</h3>
            <p class="mb-4">Ця Політика конфіденційності визначає порядок обробки та захисту персональних даних користувачів платформи "Батьківські директиви: невидимі нитки".</p>
            
            <h3 class="text-xl font-bold mb-4 mt-6">2. Які дані ми збираємо</h3>
            <p class="mb-2">Під час реєстрації ми збираємо:</p>
            <ul class="list-disc pl-6 mb-4">
                <li>Ім'я користувача</li>
                <li>Email адресу</li>
                <li>Автоматично згенерований позивний</li>
                <li>Інформацію про прогрес проходження курсу</li>
            </ul>
            
            <h3 class="text-xl font-bold mb-4 mt-6">3. Як ми використовуємо дані</h3>
            <p class="mb-2">Ваші дані використовуються виключно для:</p>
            <ul class="list-disc pl-6 mb-4">
                <li>Надання доступу до курсу</li>
                <li>Відстеження вашого прогресу</li>
                <li>Відправки коду доступу на email</li>
                <li>Покращення якості курсу</li>
            </ul>
            
            <h3 class="text-xl font-bold mb-4 mt-6">4. Захист даних</h3>
            <p class="mb-4">Всі дані зберігаються локально у вашому браузері (LocalStorage). Ми не передаємо ваші персональні дані третім особам без вашої згоди.</p>
            
            <h3 class="text-xl font-bold mb-4 mt-6">5. Ваші права</h3>
            <p class="mb-2">Ви маєте право:</p>
            <ul class="list-disc pl-6 mb-4">
                <li>Переглядати свої персональні дані</li>
                <li>Редагувати свій профіль</li>
                <li>Видалити свій акаунт у будь-який момент</li>
            </ul>
            
            <h3 class="text-xl font-bold mb-4 mt-6">6. Контакти</h3>
            <p class="mb-4">З питань конфіденційності звертайтеся: <a href="mailto:psiholikar@gmail.com" class="text-blue-600 hover:underline">psiholikar@gmail.com</a></p>
            
            <h3 class="text-xl font-bold mb-4 mt-6">7. Реквізити</h3>
            <p class="mb-2"><strong>ФОП Казар'ян Павло Ашотович</strong></p>
            <p class="mb-2">ІПН: 2847814635</p>
            <p class="mb-2">IBAN: UA613052990000026006001711340</p>
            <p class="mb-2">Адреса: Україна, 57508, Миколаївська обл., місто Очаків, вул Потьомкіна, будинок 4, квартира 74</p>
            <p class="mb-4">Email: <a href="mailto:psiholikar@gmail.com" class="text-blue-600 hover:underline">psiholikar@gmail.com</a></p>
        `,
        disclaimer: `
            <h3 class="text-xl font-bold mb-4">1. Призначення курсу</h3>
            <p class="mb-4">Курс "Батьківські директиви: невидимі нитки" має інформаційно-освітній характер і призначений для самопізнання та особистісного зростання.</p>
            
            <h3 class="text-xl font-bold mb-4 mt-6">2. Обмеження відповідальності</h3>
            <p class="mb-4">Цей курс НЕ є:</p>
            <ul class="list-disc pl-6 mb-4">
                <li>Медичною послугою чи лікуванням</li>
                <li>Психотерапією чи консультуванням</li>
                <li>Заміною професійної психологічної допомоги</li>
                <li>Гарантією вирішення всіх особистих проблем</li>
            </ul>
            
            <h3 class="text-xl font-bold mb-4 mt-6">3. Рекомендації</h3>
            <p class="mb-4">Якщо ви відчуваєте серйозні психологічні труднощі, депресію, тривожність або суїцидальні думки, будь ласка, зверніться до кваліфікованого психолога, психотерапевта або психіатра.</p>
            
            <h3 class="text-xl font-bold mb-4 mt-6">4. Результати</h3>
            <p class="mb-4">Результати проходження курсу індивідуальні і залежать від багатьох факторів. Ми не гарантуємо конкретних результатів або змін у вашому житті.</p>
            
            <h3 class="text-xl font-bold mb-4 mt-6">5. Відповідальність користувача</h3>
            <p class="mb-4">Ви несете повну відповідальність за використання інформації з курсу та її застосування у своєму житті. Проходження курсу здійснюється на ваш власний розсуд і ризик.</p>
            
            <h3 class="text-xl font-bold mb-4 mt-6">6. Авторські права</h3>
            <p class="mb-4">Всі матеріали курсу захищені авторським правом. Копіювання, розповсюдження або комерційне використання без письмового дозволу заборонено.</p>
            
            <h3 class="text-xl font-bold mb-4 mt-6">7. Контакти</h3>
            <p class="mb-4">ФОП Казар'ян Павло Ашотович<br>
Email: <a href="mailto:psiholikar@gmail.com" class="text-blue-600 hover:underline">psiholikar@gmail.com</a></p>
        `,
        terms: `
            <h3 class="text-xl font-bold mb-4">1. Предмет договору</h3>
            <p class="mb-4">Цей договір публічної оферти регулює відносини між адміністрацією платформи "Батьківські директиви: невидимі нитки" (надалі - Виконавець) та користувачем (надалі - Замовник).</p>
            
            <h3 class="text-xl font-bold mb-4 mt-6">2. Предмет послуг</h3>
            <p class="mb-4">Виконавець надає Замовнику доступ до онлайн-курсу, який включає:</p>
            <ul class="list-disc pl-6 mb-4">
                <li>17 відео-уроків</li>
                <li>85 питань для самоперевірки</li>
                <li>Робочий зошит для нотаток</li>
                <li>ШІ-помічника для підтримки</li>
                <li>Сертифікат після завершення курсу</li>
            </ul>
            
            <h3 class="text-xl font-bold mb-4 mt-6">3. Порядок надання послуг</h3>
            <p class="mb-4">3.1. Для отримання доступу Замовник проходить реєстрацію на платформі.</p>
            <p class="mb-4">3.2. Після реєстрації Замовник отримує унікальний код доступу на email.</p>
            <p class="mb-4">3.3. Доступ до курсу надається на необмежений термін.</p>
            
            <h3 class="text-xl font-bold mb-4 mt-6">4. Права та обов'язки Замовника</h3>
            <p class="mb-4">4.1. Замовник має право:</p>
            <ul class="list-disc pl-6 mb-4">
                <li>Проходити курс у зручному темпі</li>
                <li>Переглядати матеріали необмежену кількість разів</li>
                <li>Видалити свій акаунт у будь-який момент</li>
            </ul>
            <p class="mb-4">4.2. Замовник зобов'язується:</p>
            <ul class="list-disc pl-6 mb-4">
                <li>Надати достовірну інформацію при реєстрації</li>
                <li>Не передавати свій код доступу третім особам</li>
                <li>Не використовувати матеріали курсу в комерційних цілях</li>
            </ul>
            
            <h3 class="text-xl font-bold mb-4 mt-6">5. Права та обов'язки Виконавця</h3>
            <p class="mb-4">5.1. Виконавець зобов'язується:</p>
            <ul class="list-disc pl-6 mb-4">
                <li>Забезпечити доступ до курсу після реєстрації</li>
                <li>Підтримувати працездатність платформи</li>
                <li>Захищати персональні дані користувачів</li>
            </ul>
            <p class="mb-4">5.2. Виконавець має право:</p>
            <ul class="list-disc pl-6 mb-4">
                <li>Оновлювати та змінювати контент курсу</li>
                <li>Призупинити доступ користувача у разі порушення умов</li>
                <li>Змінювати умови договору з повідомленням користувачів</li>
            </ul>
            
            <h3 class="text-xl font-bold mb-4 mt-6">6. Вартість послуг</h3>
            <p class="mb-4">На момент укладення договору курс надається безкоштовно. Виконавець залишає за собою право змінити умови доступу та ввести платні опції.</p>
            
            <h3 class="text-xl font-bold mb-4 mt-6">7. Відповідальність сторін</h3>
            <p class="mb-4">7.1. Виконавець не несе відповідальності за:</p>
            <ul class="list-disc pl-6 mb-4">
                <li>Результати застосування знань з курсу</li>
                <li>Технічні збої не з вини Виконавця</li>
                <li>Втрату коду доступу з вини Замовника</li>
            </ul>
            
            <h3 class="text-xl font-bold mb-4 mt-6">8. Форс-мажор</h3>
            <p class="mb-4">Сторони звільняються від відповідальності за невиконання зобов'язань у разі форс-мажорних обставин.</p>
            
            <h3 class="text-xl font-bold mb-4 mt-6">9. Прийняття умов</h3>
            <p class="mb-4">Реєстрація на платформі означає повну та беззастережну згоду з умовами цього договору.</p>
            
            <h3 class="text-xl font-bold mb-4 mt-6">10. Реквізити Виконавця</h3>
            <div class="bg-gray-50 p-4 rounded-lg">
                <p class="mb-2"><strong>ФОП Казар'ян Павло Ашотович</strong></p>
                <p class="mb-2">🏛️ Адреса: Україна, 57508, Миколаївська обл., місто Очаків,<br>вул. Потьомкіна, будинок 4, квартира 74 (листування)</p>
                <p class="mb-2">🆔 ІПН: 2847814635</p>
                <p class="mb-2">💳 IBAN: UA613052990000026006001711340</p>
                <p class="mb-2">📧 Email: <a href="mailto:psiholikar@gmail.com" class="text-blue-600 hover:underline">psiholikar@gmail.com</a></p>
            </div>
        `
    };
    
    document.getElementById('legal-title').textContent = titles[type];
    document.getElementById('legal-content').innerHTML = contents[type];
    document.getElementById('modal-legal').classList.remove('hidden');
}

function closeLegalDoc() {
    document.getElementById('modal-legal').classList.add('hidden');
}

function exportUsers() {
    const users = [];
    
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('user_')) {
            try {
                const userData = JSON.parse(localStorage.getItem(key));
                users.push(userData);
            } catch (e) {}
        }
    }
    
    if (users.length === 0) {
        alert('Немає користувачів для експорту');
        return;
    }
    
    let csv = 'Ім\'я,Email,Прогрес,Бали,Дата реєстрації\n';
    
    users.forEach(user => {
        const progress = user.completed ? user.completed.length : 0;
        const score = user.score || 0;
        const date = new Date(user.registeredAt).toLocaleDateString('uk-UA');
        
        csv += `"${user.name}","${user.email}",${progress}/16,${score},"${date}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', 'users_' + new Date().toISOString().split('T')[0] + '.csv');
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

let adminAiMessages = [];

function toggleAdminAI() {
    const ai = document.getElementById('admin-ai-assistant');
    ai.classList.toggle('hidden');
    
    if (!ai.classList.contains('hidden') && adminAiMessages.length === 0) {
        addAdminAIMessage('assistant', '👋 Вітаю! Я ваш ШІ аналітик.\n\nЯ можу:\n• 📊 Аналізувати прогрес усіх студентів\n• 📝 Аналізувати записи в робочих зошитах\n• ⚠️ Виявляти студентів, які потребують уваги\n• 🏆 Знаходити кращих студентів\n• 💡 Давати рекомендації щодо поліпшення курсу\n\nВикористовуйте кнопки або задайте своє питання!');
    }
}

function addAdminAIMessage(role, content) {
    const chatDiv = document.getElementById('admin-ai-chat');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    messageDiv.textContent = content;
    chatDiv.appendChild(messageDiv);
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

function getAllUsersData() {
    const users = [];
    
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('user_')) {
            try {
                const userData = JSON.parse(localStorage.getItem(key));
                users.push(userData);
            } catch (e) {}
        }
    }
    
    return users;
}

async function sendAdminAIMessage() {
    const input = document.getElementById('admin-ai-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    input.value = '';
    addAdminAIMessage('user', message);
    adminAiMessages.push({ role: 'user', content: message });
    
    const users = getAllUsersData();
    const usersContext = users.map(u => ({
        name: u.name,
        callsign: u.callsign,
        progress: u.completed ? u.completed.length : 0,
        score: u.score || 0,
        workbook: u.workbook || '',
        registeredAt: u.registeredAt
    }));
    
    const thinkingDiv = document.createElement('div');
    thinkingDiv.className = 'message assistant';
    thinkingDiv.innerHTML = '🤔 Аналізую дані...';
    thinkingDiv.id = 'admin-thinking';
    document.getElementById('admin-ai-chat').appendChild(thinkingDiv);
    
    try {
        const response = await fetch('https://inviz-threads.phil-1879nlp.workers.dev/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: 'gpt-4',
                messages: [
                    { 
                        role: 'system', 
                        content: `Ти ШІ аналітик для адміністратора курсу "Батьківські директиви". Аналізуй дані користувачів та давай корисні рекомендації.\n\nКурс складається з 17 уроків, максимум 425 балів.\n\nДані користувачів: ${JSON.stringify(usersContext)}\n\nВідповідай українською, будь конкретним, давай статистику та рекомендації.` 
                    },
                    ...adminAiMessages
                ],
                max_tokens: 800,
                temperature: 0.7
            })
        });
        
        document.getElementById('admin-thinking')?.remove();
        
        if (response.ok) {
            const data = await response.json();
            const reply = data.choices[0].message.content;
            adminAiMessages.push({ role: 'assistant', content: reply });
            addAdminAIMessage('assistant', reply);
        } else {
            addAdminAIMessage('assistant', '❌ Вибачте, виникла помилка. Спробуйте ще раз.');
        }
    } catch (error) {
        document.getElementById('admin-thinking')?.remove();
        addAdminAIMessage('assistant', '❌ Помилка зв\'\u044fзку з сервером.');
    }
}

async function analyzeAllUsers() {
    const users = getAllUsersData();
    
    if (users.length === 0) {
        addAdminAIMessage('assistant', '⚠️ Немає зареєстрованих користувачів для аналізу.');
        return;
    }
    
    addAdminAIMessage('user', '📊 Аналіз усіх користувачів');
    
    const message = `Проаналізуй загальну статистику усіх ${users.length} користувачів. Дай загальний огляд: середній прогрес, середній бал, скільки завершили, скільки в процесі, скільки тільки почали. Дай рекомендації для поліпшення залученості.`;
    
    adminAiMessages.push({ role: 'user', content: message });
    
    await sendAdminAIAnalysis(message, users);
}

async function analyzeLowPerformers() {
    const users = getAllUsersData();
    const lowPerformers = users.filter(u => {
        const progress = u.completed ? u.completed.length : 0;
        return progress < 5 && progress > 0;
    });
    
    if (lowPerformers.length === 0) {
        addAdminAIMessage('assistant', '✅ Всі студенти добре прогресують! Немає тих, хто відстає.');
        return;
    }
    
    addAdminAIMessage('user', '⚠️ Аналіз студентів зі слабким прогресом');
    
    const message = `Проаналізуй ${lowPerformers.length} студентів, які мають слабкий прогрес (менше 5 уроків). Чому вони можуть відставати? Як їх мотивувати продовжити?`;
    
    adminAiMessages.push({ role: 'user', content: message });
    
    await sendAdminAIAnalysis(message, lowPerformers);
}

async function analyzeTopPerformers() {
    const users = getAllUsersData();
    const topPerformers = users.filter(u => {
        const progress = u.completed ? u.completed.length : 0;
        return progress >= 15;
    });
    
    if (topPerformers.length === 0) {
        addAdminAIMessage('assistant', '📊 Поки що немає студентів, які майже завершили курс.');
        return;
    }
    
    addAdminAIMessage('user', '🏆 Аналіз кращих студентів');
    
    const message = `Проаналізуй ${topPerformers.length} кращих студентів (пройшли 15+ уроків). Що вони роблять правильно? Які паттерни можна використати для мотивації інших?`;
    
    adminAiMessages.push({ role: 'user', content: message });
    
    await sendAdminAIAnalysis(message, topPerformers);
}

async function sendAdminAIAnalysis(message, users) {
    const usersContext = users.map(u => ({
        name: u.name,
        callsign: u.callsign,
        progress: u.completed ? u.completed.length : 0,
        score: u.score || 0,
        workbook: u.workbook ? u.workbook.substring(0, 500) : '',
        registeredAt: u.registeredAt
    }));
    
    const thinkingDiv = document.createElement('div');
    thinkingDiv.className = 'message assistant';
    thinkingDiv.innerHTML = '🤔 Аналізую дані...';
    thinkingDiv.id = 'admin-thinking';
    document.getElementById('admin-ai-chat').appendChild(thinkingDiv);
    
    try {
        const response = await fetch('https://inviz-threads.phil-1879nlp.workers.dev/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: 'gpt-4',
                messages: [
                    { 
                        role: 'system', 
                        content: `Ти ШІ аналітик для адміністратора курсу "Батьківські директиви". Аналізуй дані користувачів та давай корисні рекомендації.\n\nКурс складається з 17 уроків, максимум 425 балів.\n\nДані користувачів: ${JSON.stringify(usersContext)}\n\nВідповідай українською, будь конкретним, давай статистику та рекомендації.` 
                    },
                    { role: 'user', content: message }
                ],
                max_tokens: 800,
                temperature: 0.7
            })
        });
        
        document.getElementById('admin-thinking')?.remove();
        
        if (response.ok) {
            const data = await response.json();
            const reply = data.choices[0].message.content;
            adminAiMessages.push({ role: 'assistant', content: reply });
            addAdminAIMessage('assistant', reply);
        } else {
            addAdminAIMessage('assistant', '❌ Вибачте, виникла помилка. Спробуйте ще раз.');
        }
    } catch (error) {
        document.getElementById('admin-thinking')?.remove();
        addAdminAIMessage('assistant', '❌ Помилка зв\'\u044fзку з сервером.');
    }
}

let currentChatUserEmail = null;

function getMessagesKey(userEmail) {
    return 'messages_' + userEmail;
}

function getMessages(userEmail) {
    const data = localStorage.getItem(getMessagesKey(userEmail));
    return data ? JSON.parse(data) : [];
}

function saveMessages(userEmail, messages) {
    localStorage.setItem(getMessagesKey(userEmail), JSON.stringify(messages));
}

function addMessageToChat(chatElementId, sender, text, timestamp) {
    const chatDiv = document.getElementById(chatElementId);
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender === 'admin' ? 'assistant' : 'user'}`;
    
    const time = new Date(timestamp).toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
    const senderLabel = sender === 'admin' ? '👑 Адмін' : '👤 Ви';
    
    messageDiv.innerHTML = `<div class="text-xs text-gray-500 mb-1">${senderLabel} • ${time}</div><div>${text}</div>`;
    chatDiv.appendChild(messageDiv);
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

function openAdminChat(userEmail) {
    currentChatUserEmail = userEmail;
    const userData = localStorage.getItem('user_' + userEmail);
    
    if (!userData) {
        alert('Користувач не знайдений');
        return;
    }
    
    const user = JSON.parse(userData);
    document.getElementById('admin-chat-user-name').textContent = `${user.name} (${user.email})`;
    
    const chatDiv = document.getElementById('admin-chat-messages');
    chatDiv.innerHTML = '';
    
    const messages = getMessages(userEmail);
    if (messages.length === 0) {
        addMessageToChat('admin-chat-messages', 'system', '👋 Почніть розмову з користувачем...', Date.now());
    } else {
        messages.forEach(msg => {
            addMessageToChat('admin-chat-messages', msg.sender, msg.text, msg.timestamp);
            if (msg.sender === 'user' && !msg.read) {
                msg.read = true;
            }
        });
        saveMessages(userEmail, messages);
        loadAdminPanel();
    }
    
    document.getElementById('admin-chat-modal').classList.remove('hidden');
    document.getElementById('admin-chat-input').focus();
}

function closeAdminChat() {
    document.getElementById('admin-chat-modal').classList.add('hidden');
    currentChatUserEmail = null;
}

function sendAdminMessage() {
    const input = document.getElementById('admin-chat-input');
    const text = input.value.trim();
    
    if (!text || !currentChatUserEmail) return;
    
    const message = {
        sender: 'admin',
        text: text,
        timestamp: Date.now(),
        read: false
    };
    
    const messages = getMessages(currentChatUserEmail);
    messages.push(message);
    saveMessages(currentChatUserEmail, messages);
    
    addMessageToChat('admin-chat-messages', 'admin', text, message.timestamp);
    input.value = '';
}

function toggleUserMessages() {
    const modal = document.getElementById('user-messages');
    const isHidden = modal.classList.contains('hidden');
    
    modal.classList.toggle('hidden');
    
    if (isHidden) {
        loadUserMessages();
    }
}

function loadUserMessages() {
    if (!currentUser) return;
    
    const chatDiv = document.getElementById('user-messages-chat');
    chatDiv.innerHTML = '';
    
    const messages = getMessages(currentUser.email);
    
    if (messages.length === 0) {
        addMessageToChat('user-messages-chat', 'system', '👋 Вітаємо! Тут ви можете спілкуватися з адміністратором курсу.\n\nНапишіть своє питання або коментар!', Date.now());
    } else {
        messages.forEach(msg => {
            addMessageToChat('user-messages-chat', msg.sender, msg.text, msg.timestamp);
            if (!msg.read && msg.sender === 'admin') {
                msg.read = true;
            }
        });
        saveMessages(currentUser.email, messages);
        updateUnreadBadge();
    }
    
    document.getElementById('user-message-input').focus();
}

function sendUserMessage() {
    if (!currentUser) return;
    
    const input = document.getElementById('user-message-input');
    const text = input.value.trim();
    
    if (!text) return;
    
    const message = {
        sender: 'user',
        text: text,
        timestamp: Date.now(),
        read: false
    };
    
    const messages = getMessages(currentUser.email);
    messages.push(message);
    saveMessages(currentUser.email, messages);
    
    addMessageToChat('user-messages-chat', 'user', text, message.timestamp);
    input.value = '';
}

function updateUnreadBadge() {
    if (!currentUser) return;
    
    const messages = getMessages(currentUser.email);
    const unreadCount = messages.filter(m => m.sender === 'admin' && !m.read).length;
    
    const badge = document.getElementById('unread-badge');
    if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

setInterval(() => {
    if (currentUser && currentScreen === 'dashboard') {
        updateUnreadBadge();
    }
    
    if (currentScreen === 'admin') {
        const currentTable = document.getElementById('admin-users-table');
        if (currentTable && currentTable.children.length > 0) {
            loadAdminPanel();
        }
    }
}, 5000);

window.showScreen = showScreen;

function refreshVideoErrorLogs() {
    const errorLogs = JSON.parse(localStorage.getItem('video_error_logs') || '[]');
    
    const totalErrors = errorLogs.length;
    const loadErrors = errorLogs.filter(e => e.errorType === 'load_error').length;
    const slowLoads = errorLogs.filter(e => e.errorType === 'slow_load').length;
    const userReported = errorLogs.filter(e => e.errorType === 'user_reported').length;
    
    const statsContainer = document.getElementById('video-error-stats');
    statsContainer.innerHTML = `
        <div class="bg-red-50 p-4 rounded-lg border-2 border-red-200">
            <div class="text-2xl font-black text-red-600">${totalErrors}</div>
            <div class="text-sm text-gray-700">Загалом помилок</div>
        </div>
        <div class="bg-orange-50 p-4 rounded-lg border-2 border-orange-200">
            <div class="text-2xl font-black text-orange-600">${loadErrors}</div>
            <div class="text-sm text-gray-700">Помилок завантаження</div>
        </div>
        <div class="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-200">
            <div class="text-2xl font-black text-yellow-600">${slowLoads}</div>
            <div class="text-sm text-gray-700">Повільне завантаження</div>
        </div>
        <div class="bg-purple-50 p-4 rounded-lg border-2 border-purple-200">
            <div class="text-2xl font-black text-purple-600">${userReported}</div>
            <div class="text-sm text-gray-700">Скарги користувачів</div>
        </div>
    `;
    
    const tbody = document.getElementById('video-error-logs-table');
    
    if (errorLogs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">Немає помилок відео 🎉</td></tr>';
        return;
    }
    
    const recentErrors = errorLogs.slice(-100).reverse();
    
    tbody.innerHTML = recentErrors.map(log => {
        const time = new Date(log.timestamp).toLocaleString('uk-UA', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
        const errorTypeLabels = {
            'load_error': '❌ Помилка завантаження',
            'slow_load': '⚠️ Повільно',
            'user_reported': '📢 Скарга'
        };
        const errorLabel = errorTypeLabels[log.errorType] || log.errorType;
        const issue = log.issue ? `<div class="text-xs text-gray-500 mt-1">""${log.issue}""</div>` : '';
        
        return `
            <tr class="border-b hover:bg-gray-50">
                <td class="py-2 px-3 text-xs text-gray-600">${time}</td>
                <td class="py-2 px-3">Урок ${log.lessonId} (Частина ${log.partNum})</td>
                <td class="py-2 px-3 font-mono text-xs">${log.videoId}</td>
                <td class="py-2 px-3">${errorLabel}</td>
                <td class="py-2 px-3 text-sm">${log.userName}<br><span class="text-xs text-gray-500">${log.userEmail}</span></td>
                <td class="py-2 px-3 text-xs">${issue}</td>
            </tr>
        `;
    }).join('');
}

function clearVideoErrorLogs() {
    if (confirm('Ви впевнені, що хочете осчистити всі логи помилок відео?')) {
        localStorage.removeItem('video_error_logs');
        refreshVideoErrorLogs();
        alert('✅ Логи очищено!');
    }
}

function exportVideoErrors() {
    const errorLogs = JSON.parse(localStorage.getItem('video_error_logs') || '[]');
    
    if (errorLogs.length === 0) {
        alert('Немає логів для експорту');
        return;
    }
    
    const csv = [
        ['Timestamp', 'Lesson ID', 'Video ID', 'Part', 'Error Type', 'User Name', 'User Email', 'Issue', 'User Agent'].join(','),
        ...errorLogs.map(log => [
            log.timestamp,
            log.lessonId,
            log.videoId,
            log.partNum,
            log.errorType,
            log.userName,
            log.userEmail,
            log.issue || '',
            log.userAgent
        ].map(v => `"${v}"`).join(','))
    ].join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `video-errors-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

window.refreshVideoErrorLogs = refreshVideoErrorLogs;
window.clearVideoErrorLogs = clearVideoErrorLogs;
window.exportVideoErrors = exportVideoErrors;

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        const swCode = `
const CACHE_NAME = 'parental-directives-v1';
const urlsToCache = [
  './',
  'https://cdn.tailwindcss.com',
  'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap',
  'https://res2.weblium.site/res/656e15d29a2eb3000f9a162d/656f023ff0279b000f7b941b_optimized_262.webp'
];

self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => cache.addAll(urlsToCache))
  );
});

self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request)
      .then(response => response || fetch(event.request))
      .catch(() => {
        if (event.request.destination === 'document') {
          return caches.match('./');
        }
      })
  );
});

self.addEventListener('activate', event => {
  event.waitUntil(
    caches.keys().then(cacheNames => {
      return Promise.all(
        cacheNames.map(cacheName => {
          if (cacheName !== CACHE_NAME) {
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
});
        `;
        
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        
        navigator.serviceWorker.register(swUrl)
            .then(registration => {
                console.log('✅ Service Worker зареєстровано:', registration.scope);
                checkForUpdates(registration);
            })
            .catch(err => console.log('❌ Service Worker помилка:', err));
    });
}

function checkForUpdates(registration) {
    setInterval(() => {
        registration.update();
    }, 60000);
}

let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    showInstallPrompt();
});

function showInstallPrompt() {
    const installBanner = document.createElement('div');
    installBanner.id = 'pwa-install-banner';
    installBanner.className = 'fixed bottom-0 left-0 right-0 bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 shadow-2xl z-50 fade-in';
    installBanner.innerHTML = `
        <div class="max-w-4xl mx-auto flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <span class="text-3xl">📱</span>
                <div>
                    <div class="font-bold">Встановіть додаток</div>
                    <div class="text-sm opacity-90">Отримайте швидкий доступ та офлайн режим</div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="installPWA()" class="bg-white text-blue-600 px-6 py-2 rounded-lg font-bold hover:bg-gray-100">
                    Встановити
                </button>
                <button onclick="dismissInstallPrompt()" class="text-white hover:text-gray-200 px-3">
                    ✕
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(installBanner);
}

window.installPWA = async function() {
    if (!deferredPrompt) return;
    
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    
    if (outcome === 'accepted') {
        console.log('✅ PWA встановлено');
    }
    
    deferredPrompt = null;
    dismissInstallPrompt();
};

window.dismissInstallPrompt = function() {
    const banner = document.getElementById('pwa-install-banner');
    if (banner) banner.remove();
};

function checkOnlineStatus() {
    const statusIndicator = document.createElement('div');
    statusIndicator.id = 'online-status';
    statusIndicator.className = 'fixed top-4 right-4 px-4 py-2 rounded-lg text-sm font-semibold shadow-lg z-50';
    
    function updateStatus() {
        if (navigator.onLine) {
            statusIndicator.className = 'fixed top-4 right-4 px-4 py-2 rounded-lg text-sm font-semibold shadow-lg z-50 bg-green-500 text-white fade-in';
            statusIndicator.innerHTML = '✅ Онлайн';
            setTimeout(() => statusIndicator.remove(), 3000);
        } else {
            statusIndicator.className = 'fixed top-4 right-4 px-4 py-2 rounded-lg text-sm font-semibold shadow-lg z-50 bg-orange-500 text-white';
            statusIndicator.innerHTML = '⚠️ Офлайн режим';
            document.body.appendChild(statusIndicator);
        }
    }
    
    window.addEventListener('online', updateStatus);
    window.addEventListener('offline', updateStatus);
    
    if (!navigator.onLine) updateStatus();
}

checkOnlineStatus();

window.toggleEmailSettings = function() {
    const modal = document.getElementById('email-settings-modal');
    modal.classList.toggle('hidden');
    if (!modal.classList.contains('hidden')) {
        loadEmailPreferences();
    }
};

function loadEmailPreferences() {
    if (!currentUser) return;
    
    const prefs = currentUser.emailPreferences || {
        newLessons: true,
        updates: true,
        reminders: false,
        weekly: false
    };
    
    document.getElementById('email-new-lessons').checked = prefs.newLessons;
    document.getElementById('email-updates').checked = prefs.updates;
    document.getElementById('email-reminders').checked = prefs.reminders;
    document.getElementById('email-weekly').checked = prefs.weekly;
}

function saveEmailPreferences() {
    if (!currentUser) return;
    
    currentUser.emailPreferences = {
        newLessons: document.getElementById('email-new-lessons').checked,
        updates: document.getElementById('email-updates').checked,
        reminders: document.getElementById('email-reminders').checked,
        weekly: document.getElementById('email-weekly').checked
    };
    
    localStorage.setItem('user_' + currentUser.email, JSON.stringify(currentUser));
    
    showEmailStatus('✅ Налаштування збережено!', 'success');
}

function showEmailStatus(message, type) {
    const statusEl = document.getElementById('email-status');
    statusEl.textContent = message;
    statusEl.className = `mb-4 p-3 rounded-lg text-sm ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
    statusEl.classList.remove('hidden');
    
    setTimeout(() => statusEl.classList.add('hidden'), 3000);
}

async function testEmailNotification() {
    if (!currentUser) return;
    
    const prefs = currentUser.emailPreferences || {};
    if (!prefs.newLessons && !prefs.updates && !prefs.reminders && !prefs.weekly) {
        showEmailStatus('⚠️ Увімкніть хоча б одне сповіщення', 'error');
        return;
    }
    
    showEmailStatus('📧 Надсилання email...', 'success');
    
    try {
        const response = await fetch(`${window.HATCH_CONFIG?.apiBaseUrl || ''}/services/send_email`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: currentUser.name,
                email: currentUser.email,
                message: `Тестове повідомлення \n\nВітаємо, ${currentUser.name}!\n\nЦе тестове повідомлення з курсу "Батьківські директиви".\n\nВаш прогрес: ${completed.size}/16 уроків\nБали: ${totalScore}\n\nНалаштування email:\n- Нові уроки: ${prefs.newLessons ? '✅' : '❌'}\n- Оновлення: ${prefs.updates ? '✅' : '❌'}\n- Нагадування: ${prefs.reminders ? '✅' : '❌'}\n- Щотижневий звіт: ${prefs.weekly ? '✅' : '❌'}\n\nЯкщо ви отримали це повідомлення, значить email сповіщення працюють коректно!`
            })
        });
        
        if (response.ok) {
            showEmailStatus('✅ Тестовий email надіслано! Перевірте свою скриньку.', 'success');
        } else {
            throw new Error('Failed to send email');
        }
    } catch (error) {
        console.error('Email error:', error);
        showEmailStatus('❌ Помилка надсилання email', 'error');
    }
}

async function sendLessonCompletionEmail(lessonId) {
    if (!currentUser || !currentUser.emailPreferences?.newLessons) return;
    
    const lesson = lessons.find(l => l.id === lessonId);
    if (!lesson) return;
    
    const nextLesson = lessons.find(l => l.id === lessonId + 1);
    if (!nextLesson) return;
    
    try {
        await fetch(`${window.HATCH_CONFIG?.apiBaseUrl || ''}/services/send_email`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: currentUser.name,
                email: currentUser.email,
                message: `Вітаємо, ${currentUser.name}!\n\n🎉 Ви завершили "${lesson.title}"!\n\nТепер вам доступний наступний урок:\n\n📚 "${nextLesson.title}"\n⭐ Бали: ${nextLesson.points}\n⏱️ Тривалість: ${nextLesson.duration}\n\nВаш прогрес: ${completed.size}/16 уроків (${Math.round((completed.size / 16) * 100)}%)\nЗагальні бали: ${totalScore}\n\nПродовжуйте навчання! 🚀`
            })
        });
    } catch (error) {
        console.error('Email notification error:', error);
    }
}

window.saveEmailPreferences = saveEmailPreferences;
window.testEmailNotification = testEmailNotification;

async function checkCacheStatus() {
    if ('caches' in window) {
        try {
            const cacheNames = await caches.keys();
            const cache = await caches.open('parental-directives-v1');
            const cachedRequests = await cache.keys();
            
            let totalSize = 0;
            for (const request of cachedRequests) {
                const response = await cache.match(request);
                if (response) {
                    const blob = await response.blob();
                    totalSize += blob.size;
                }
            }
            
            const sizeInMB = (totalSize / (1024 * 1024)).toFixed(2);
            document.getElementById('cache-size').textContent = `~ ${sizeInMB} MB`;
            document.getElementById('cache-pages-status').innerHTML = `✅ ${cachedRequests.length} сторінок`;
            
            alert(`📊 Статус офлайн кешу:\n\n📄 Сторінок: ${cachedRequests.length}\n💾 Розмір: ${sizeInMB} MB\n\nВідео YouTube не можна зберегти офлайн.`);
        } catch (error) {
            console.error('Cache status error:', error);
            alert('❌ Помилка перевірки кешу');
        }
    } else {
        alert('⚠️ Ваш браузер не підтримує офлайн режим');
    }
}

async function clearOfflineCache() {
    if (!confirm('Ви впевнені, що хочете очистити весь офлайн кеш? Після цього курс не буде доступний без інтернету.')) {
        return;
    }
    
    if ('caches' in window) {
        try {
            const cacheNames = await caches.keys();
            await Promise.all(cacheNames.map(name => caches.delete(name)));
            
            document.getElementById('cache-size').textContent = '0 MB';
            document.getElementById('cache-pages-status').innerHTML = '❌ Очищено';
            
            alert('✅ Офлайн кеш очищено!\n\nСторінка перезавантажиться для оновлення...');
            setTimeout(() => location.reload(), 1000);
        } catch (error) {
            console.error('Cache clear error:', error);
            alert('❌ Помилка очищення кешу');
        }
    } else {
        alert('⚠️ Ваш браузер не підтримує офлайн режим');
    }
}

window.checkCacheStatus = checkCacheStatus;
window.clearOfflineCache = clearOfflineCache;

if ('serviceWorker' in navigator && currentScreen === 'workbook') {
    checkCacheStatus();
}
</script>

</body>
</html>